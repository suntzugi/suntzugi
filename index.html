<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Suntzugi</title>
<link rel="icon" type="image/png" href="assets/chraist/favicon.png">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Zen+Kaku+Gothic+New:wght@300;400&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{background:#1e2a4a;color:#d4d8e8;font-family:'Zen Kaku Gothic New',sans-serif;font-weight:300;min-height:100vh;overflow-x:hidden;cursor:default;
    scrollbar-width:thin;scrollbar-color:rgba(242,160,181,.3) transparent}
  body::-webkit-scrollbar{width:4px}
  body::-webkit-scrollbar-track{background:transparent}
  body::-webkit-scrollbar-thumb{background:rgba(242,160,181,.3);border-radius:2px}
  body::-webkit-scrollbar-thumb:hover{background:rgba(242,160,181,.5)}
  .grain{position:fixed;inset:0;z-index:100;pointer-events:none;opacity:.18;mix-blend-mode:screen}
  #scene{position:fixed;inset:0;z-index:2;pointer-events:none}
  .moonlight{position:fixed;inset:0;z-index:1;pointer-events:none;
    background:radial-gradient(ellipse 90% 80% at var(--mx,45%) var(--my,15%),rgba(180,190,240,.16) 0%,rgba(130,150,210,.07) 25%,rgba(30,42,74,0) 65%);transition:background .15s linear}
  .vignette{position:fixed;inset:0;z-index:3;pointer-events:none;
    background:radial-gradient(ellipse at center,transparent 35%,rgba(10,14,30,.45) 100%)}

  /* ── Layout ── */
  .content{
    position:relative;z-index:10;min-height:100vh;
    display:flex;flex-direction:column;justify-content:center;
    padding:6vh 10vw;
    user-select:text;-webkit-user-select:text;
  }
  .ci{
    max-width:640px;opacity:0;transform:translateY(22px);
    animation:rv 1.2s cubic-bezier(.22,1,.36,1) .2s forwards;
  }
  @keyframes rv{to{opacity:1;transform:translateY(0)}}

  /* ── Title ── */
  .title{
    font-family:'Cormorant Garamond',serif;
    font-weight:300;font-style:italic;
    font-size:clamp(3.2rem,8vw,6.5rem);
    line-height:1;letter-spacing:-.03em;
    margin-bottom:0;
    user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;
    text-shadow:
      -1px -1px 0 rgba(10,14,30,.85),
       1px -1px 0 rgba(10,14,30,.85),
      -1px  1px 0 rgba(10,14,30,.85),
       1px  1px 0 rgba(10,14,30,.85),
       0 0 8px rgba(10,14,30,.7),
       0 0 20px rgba(10,14,30,.4);
  }
  .syl{
    display:inline-block;
    cursor:default;pointer-events:auto;
    transition:color .35s ease;
    position:relative;
  }
  .syl:hover,.syl.lit{color:#f2a0b5}

  /* ── Annotation zone ── */
  .hover-zone{
    pointer-events:auto;
    position:relative;
  }
  .anno-zone{
    height:clamp(180px, 35vh, 400px);
    margin-top:1.2rem;
    position:relative;
  }
  .anno-card{
    position:absolute;inset:0;
    opacity:0;
    transform:translateY(6px);
    transition:opacity .4s ease, transform .4s cubic-bezier(.22,1,.36,1);
    pointer-events:none;
    overflow-y:auto;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:thin;
    scrollbar-color:rgba(242,160,181,.3) transparent;
  }
  .anno-card::-webkit-scrollbar{width:4px}
  .anno-card::-webkit-scrollbar-track{background:transparent}
  .anno-card::-webkit-scrollbar-thumb{background:rgba(242,160,181,.3);border-radius:2px}
  .anno-card::-webkit-scrollbar-thumb:hover{background:rgba(242,160,181,.5)}
  .anno-card.show{
    opacity:1;transform:translateY(0);pointer-events:auto;
    user-select:text;-webkit-user-select:text;
  }
  .anno-card.scroll-glow::after{
    content:'';
    position:absolute;top:0;right:0;bottom:0;width:4px;
    background:rgba(242,160,181,.7);
    box-shadow:0 0 8px rgba(242,160,181,.5),0 0 16px rgba(242,160,181,.3);
    border-radius:2px;
    pointer-events:none;
    animation:scrollGlow 1.2s ease-out forwards;
  }
  @keyframes scrollGlow{
    0%{opacity:1}
    60%{opacity:.6}
    100%{opacity:0}
  }

  /* Card inner layout */
  .ac-top{
    display:flex;align-items:baseline;gap:1rem;
    margin-bottom:.5rem;
    flex-shrink:0;
  }
  .ac-char{
    font-family:'Cormorant Garamond',serif;
    font-size:2rem;font-weight:300;
    color:#f2a0b5;opacity:.65;
    line-height:1;
    flex-shrink:0;white-space:nowrap;
  }
  .ac-label{
    font-family:'Zen Kaku Gothic New',sans-serif;
    font-size:.6rem;letter-spacing:.2em;text-transform:uppercase;
    color:#6b7394;
  }
  .ac-body{
    font-family:'Cormorant Garamond',serif;
    font-size:.92rem;font-weight:300;font-style:italic;
    color:#a0a8c8;
    line-height:1.7;
    max-width:500px;
    text-shadow:
      -1px -1px 0 rgba(10,14,30,.8),
       1px -1px 0 rgba(10,14,30,.8),
      -1px  1px 0 rgba(10,14,30,.8),
       1px  1px 0 rgba(10,14,30,.8),
       0 0 8px rgba(10,14,30,.6);
  }
  .ac-quote{
    font-family:'Cormorant Garamond',serif;
    font-size:.88rem;font-weight:300;font-style:italic;
    color:#c0c6de;opacity:.7;
    line-height:1.6;
    margin-top:.6rem;
    padding-left:1rem;
    border-left:1px solid rgba(242,160,181,.2);
    max-width:400px;
    text-shadow:
      -1px -1px 0 rgba(10,14,30,.8),
       1px -1px 0 rgba(10,14,30,.8),
      -1px  1px 0 rgba(10,14,30,.8),
       1px  1px 0 rgba(10,14,30,.8),
       0 0 8px rgba(10,14,30,.6);
  }
  .ac-quote .attr{
    display:block;
    margin-top:.2rem;
    font-style:normal;font-size:.6rem;
    letter-spacing:.15em;text-transform:uppercase;
    color:#6b7394;
  }
  .ac-body a, .ac-quote a, .ac-link{
    color:#f2a0b5;opacity:.7;
    text-decoration:none;
    border-bottom:1px solid rgba(242,160,181,.25);
    transition:opacity .3s ease, border-color .3s ease;
    pointer-events:auto;
  }
  .ac-body a:hover, .ac-quote a:hover, .ac-link:hover{
    opacity:1;border-color:rgba(242,160,181,.6);
  }
  .ac-sep{
    width:40px;height:1px;
    background:rgba(242,160,181,.15);
    margin:.8rem 0;
  }

  /* ── Essay mode ── */
  .essay-view{
    position:fixed;inset:0;z-index:50;
    overflow-y:auto;
    opacity:0;pointer-events:none;
    transition:opacity .5s ease;
    scrollbar-width:thin;scrollbar-color:rgba(242,160,181,.3) transparent;
  }
  .essay-view::-webkit-scrollbar{width:4px}
  .essay-view::-webkit-scrollbar-track{background:transparent}
  .essay-view::-webkit-scrollbar-thumb{background:rgba(242,160,181,.3);border-radius:2px}
  .essay-view::-webkit-scrollbar-thumb:hover{background:rgba(242,160,181,.5)}
  .essay-view.open{opacity:1;pointer-events:auto}
  .essay-view-inner{
    max-width:600px;
    margin:0 auto;
    padding:12vh 2rem 10vh;
    text-align:center;
  }
  .essay-view-title{
    font-family:'Cormorant Garamond',serif;
    font-weight:300;font-style:italic;
    font-size:clamp(1.8rem,4vw,2.8rem);
    color:#d4d8e8;
    margin-bottom:3rem;
    line-height:1.3;
    text-shadow:
      -1px -1px 0 rgba(10,14,30,.85),
       1px -1px 0 rgba(10,14,30,.85),
      -1px  1px 0 rgba(10,14,30,.85),
       1px  1px 0 rgba(10,14,30,.85),
       0 0 10px rgba(10,14,30,.7),
       0 0 24px rgba(10,14,30,.4);
  }
  .essay-view-body{
    font-family:'Cormorant Garamond',serif;
    font-weight:300;
    font-size:clamp(1rem,1.8vw,1.15rem);
    color:#a0a8c8;
    line-height:2.2;
    text-align:left;
    text-shadow:
      -1px -1px 0 rgba(10,14,30,.8),
       1px -1px 0 rgba(10,14,30,.8),
      -1px  1px 0 rgba(10,14,30,.8),
       1px  1px 0 rgba(10,14,30,.8),
       0 0 8px rgba(10,14,30,.6);
  }
  .essay-view-body p{margin-bottom:1.5rem}
  .essay-view-body a{
    color:rgba(242,160,181,.7);
    text-decoration:none;border-bottom:1px solid rgba(242,160,181,.25);
    transition:color .3s ease, border-color .3s ease;
  }
  .essay-view-body a:hover{
    color:rgba(242,160,181,1);
    border-color:rgba(242,160,181,.5);
  }
  .essay-meta{
    margin-top:2.5rem;
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.55rem;letter-spacing:.08em;
    color:rgba(242,160,181,.3);
  }

  /* ── Neodore popup ── */
  .neodore-overlay{
    position:fixed;inset:0;z-index:200;
    display:flex;align-items:center;justify-content:center;
    background:rgba(6,9,18,.85);
    opacity:0;pointer-events:none;
    transition:opacity .4s ease;
    -webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);
  }
  .neodore-overlay.open{opacity:1;pointer-events:auto}
  .neodore-popup{
    text-align:center;padding:2.5rem 2rem;
    max-width:420px;width:90vw;position:relative;
  }
  .neodore-close{
    position:absolute;top:1rem;right:1rem;
    width:28px;height:28px;
    border:1px solid rgba(242,160,181,.15);border-radius:50%;
    background:none;color:rgba(242,160,181,.5);
    font-family:'SF Mono',monospace;font-size:.7rem;
    cursor:pointer;display:flex;align-items:center;justify-content:center;
    transition:border-color .3s,color .3s;
  }
  .neodore-close:hover,.neodore-close.tap-glow{border-color:rgba(242,160,181,.4);color:rgba(242,160,181,.8);box-shadow:0 0 10px rgba(242,160,181,.3)}
  .neodore-title{
    font-family:'Cormorant Garamond',serif;
    font-weight:300;font-style:italic;
    font-size:1.8rem;letter-spacing:.08em;
    color:rgba(242,160,181,.85);
    margin-bottom:1.5rem;
  }
  .neodore-line{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.7rem;letter-spacing:.06em;
    color:rgba(242,160,181,.55);
    margin:0 0 .4rem;line-height:1.6;
  }
  .neodore-timer{
    margin-top:1.5rem;
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.85rem;letter-spacing:.08em;
    color:rgba(242,160,181,.7);
  }
  .neodore-soon{
    margin-top:.5rem;
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.55rem;letter-spacing:.15em;text-transform:uppercase;
    color:rgba(242,160,181,.35);
  }
  .neodore-contact{
    margin-top:1.5rem;
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.6rem;letter-spacing:.04em;
    color:rgba(242,160,181,.35);
    line-height:1.8;
  }
  .neodore-contact a{
    color:rgba(242,160,181,.55);
    text-decoration:none;border-bottom:1px solid rgba(242,160,181,.2);
    transition:color .3s ease, border-color .3s ease;
  }
  .neodore-contact a:hover{
    color:rgba(242,160,181,.85);
    border-color:rgba(242,160,181,.5);
  }

  /* ── Audio toggle ── */
  .audio-btn{
    position:fixed;top:1.5rem;right:1.5rem;z-index:120;
    width:40px;height:40px;
    border-radius:50%;border:none;outline:none;
    background:transparent;
    cursor:pointer;
    display:flex;align-items:center;justify-content:center;
    transition:background .1s ease;
    pointer-events:auto;
    user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;
  }
  .audio-btn:hover{background:rgba(242,160,181,.08)}
  .audio-btn.playing{background:rgba(242,160,181,.12);transition:background .4s ease}
  .audio-btn canvas{display:block}

  /* ── Now playing label ── */
  @keyframes npPulse{
    0%,100%{opacity:.5;text-shadow:0 0 4px rgba(242,160,181,.1)}
    50%{opacity:1;text-shadow:0 0 8px rgba(242,160,181,.25)}
  }
  .now-playing{
    position:fixed;bottom:1.5rem;right:1.5rem;z-index:120;
    text-align:right;
    opacity:0;
    transform:translateY(6px);
    transition:opacity .8s ease, transform .8s ease;
    pointer-events:none;
  }
  .now-playing.show{
    opacity:1;transform:translateY(0);
    pointer-events:auto;
  }
  .now-playing .np-label{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.5rem;
    letter-spacing:.18em;
    text-transform:uppercase;
    color:rgba(242,160,181,.4);
    margin-bottom:.2rem;
    animation:npPulse 6s ease-in-out infinite;
  }
  .now-playing .np-dot{
    display:inline-block;
    width:4px;height:4px;
    border-radius:50%;
    background:rgba(242,160,181,.6);
    margin-right:.4rem;
    vertical-align:middle;
    animation:npPulse 6s ease-in-out infinite;
  }
  .now-playing .np-info{
    cursor:pointer;
    transition:color .3s ease;
  }
  .now-playing .np-info:hover .np-title{color:rgba(242,160,181,.9)}
  .now-playing .np-title{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.65rem;
    color:rgba(242,160,181,.65);
    font-style:normal;
    letter-spacing:.04em;
    transition:color .3s ease;
  }
  .now-playing .np-artist{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.5rem;
    color:rgba(242,160,181,.35);
    margin-top:.15rem;
    letter-spacing:.06em;
  }

  /* ── Song picker ── */
  .song-picker{
    position:fixed;bottom:4.5rem;right:1.5rem;z-index:130;
    background:rgba(20,30,55,.92);
    backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
    border:1px solid rgba(242,160,181,.12);
    border-radius:6px;
    padding:.4rem 0;
    opacity:0;
    transform:translateY(8px) scale(.96);
    transition:opacity .25s ease, transform .25s ease;
    pointer-events:none;
    min-width:180px;
  }
  .song-picker.open{
    opacity:1;transform:translateY(0) scale(1);
    pointer-events:auto;
  }
  .song-picker-item{
    display:block;width:100%;border:none;background:none;
    text-align:right;
    padding:.45rem .8rem;
    cursor:pointer;
    transition:background .2s ease;
  }
  .song-picker-item:hover{background:rgba(242,160,181,.08)}
  .song-picker-item.active{background:rgba(242,160,181,.06)}
  .song-picker-item .sp-title{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.6rem;
    color:rgba(242,160,181,.6);
    letter-spacing:.03em;
  }
  .song-picker-item .sp-artist{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.45rem;
    color:rgba(242,160,181,.3);
    letter-spacing:.05em;
  }
  .song-picker-item.active .sp-title{color:rgba(242,160,181,.85)}
  .song-picker-item.active .sp-artist{color:rgba(242,160,181,.5)}

  /* ── Edit Panel ── */
  .edit-panel{
    position:fixed;top:0;right:0;bottom:0;z-index:200;
    width:320px;max-width:90vw;
    background:rgba(15,20,40,.88);
    backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
    border-left:1px solid rgba(242,160,181,.1);
    padding:2rem 1.5rem;
    overflow-y:auto;scrollbar-width:none;
    opacity:0;transform:translateX(20px);
    transition:opacity .3s ease,transform .3s ease;
    pointer-events:none;
  }
  .edit-panel::-webkit-scrollbar{width:0}
  .edit-panel.open{opacity:1;transform:translateX(0);pointer-events:auto}
  .edit-panel .ep-header{
    display:flex;justify-content:space-between;align-items:flex-start;
    margin-bottom:1.5rem;
  }
  .edit-panel .ep-title{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.65rem;letter-spacing:.15em;text-transform:lowercase;
    color:rgba(242,160,181,.5);
  }
  .edit-panel .ep-presets{display:flex;gap:.4rem;margin-top:.4rem;flex-wrap:wrap}
  .edit-panel .ep-preset-btn{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.45rem;letter-spacing:.08em;
    color:rgba(242,160,181,.3);
    background:none;border:1px solid rgba(242,160,181,.1);
    border-radius:3px;padding:.2rem .5rem;cursor:pointer;
    transition:color .3s,border-color .3s,background .3s;
  }
  .edit-panel .ep-preset-btn:hover{
    color:rgba(242,160,181,.5);border-color:rgba(242,160,181,.25);
  }
  .edit-panel .ep-preset-btn.active{
    color:rgba(242,160,181,.7);border-color:rgba(242,160,181,.3);
    background:rgba(242,160,181,.06);
  }
  .edit-panel .ep-styles{display:flex;gap:.35rem;flex-wrap:wrap}
  .edit-panel .ep-style-btn{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.42rem;letter-spacing:.06em;
    color:rgba(212,216,232,.35);
    background:none;border:1px solid rgba(212,216,232,.1);
    border-radius:3px;padding:.18rem .45rem;cursor:pointer;
    transition:color .3s,border-color .3s,background .3s;
  }
  .edit-panel .ep-style-btn:hover{
    color:rgba(212,216,232,.55);border-color:rgba(212,216,232,.2);
  }
  .edit-panel .ep-style-btn.active{
    color:rgba(242,160,181,.7);border-color:rgba(242,160,181,.25);
    background:rgba(242,160,181,.06);
  }
  .edit-panel .ep-close{
    width:28px;height:28px;
    border:1px solid rgba(242,160,181,.15);border-radius:50%;
    background:none;color:rgba(242,160,181,.5);
    font-family:'SF Mono',monospace;font-size:.7rem;
    cursor:pointer;display:flex;align-items:center;justify-content:center;
    transition:border-color .3s,color .3s;flex-shrink:0;
  }
  .edit-panel .ep-close:hover,.edit-panel .ep-close.tap-glow{
    border-color:rgba(242,160,181,.4);color:rgba(242,160,181,.8);box-shadow:0 0 10px rgba(242,160,181,.3);
  }
  .edit-panel .ep-group{margin-bottom:1.2rem}
  .edit-panel .ep-group-title{
    font-family:'SF Mono',monospace;font-size:.5rem;
    letter-spacing:.15em;text-transform:uppercase;
    color:rgba(242,160,181,.3);margin-bottom:.6rem;
  }
  .edit-panel .ep-slider-row{
    display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem;
  }
  .edit-panel .ep-num{
    font-family:'SF Mono',monospace;font-size:.5rem;
    color:rgba(242,160,181,.25);width:1.2rem;text-align:right;flex-shrink:0;
  }
  .edit-panel .ep-slider-wrap{flex:1;display:flex;flex-direction:column}
  .edit-panel .ep-slider-info{display:flex;justify-content:space-between;margin-bottom:.2rem}
  .edit-panel .ep-slider-name{
    font-family:'SF Mono',monospace;font-size:.48rem;
    color:rgba(212,216,232,.5);letter-spacing:.05em;
  }
  .edit-panel .ep-slider-val{
    font-family:'SF Mono',monospace;font-size:.48rem;
    color:rgba(242,160,181,.5);
  }
  .edit-panel input[type="range"]{
    -webkit-appearance:none;appearance:none;width:100%;height:2px;
    background:rgba(242,160,181,.12);border-radius:1px;outline:none;cursor:pointer;
  }
  .edit-panel input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;width:10px;height:10px;border-radius:50%;
    background:rgba(242,160,181,.7);border:none;
    box-shadow:0 0 6px rgba(242,160,181,.3);cursor:pointer;
    transition:background .2s,box-shadow .2s;
  }
  .edit-panel input[type="range"]::-webkit-slider-thumb:hover{
    background:rgba(242,160,181,.9);box-shadow:0 0 10px rgba(242,160,181,.5);
  }
  .edit-panel input[type="range"]::-moz-range-thumb{
    width:10px;height:10px;border-radius:50%;
    background:rgba(242,160,181,.7);border:none;
    box-shadow:0 0 6px rgba(242,160,181,.3);cursor:pointer;
  }
  .edit-panel input[type="range"]::-moz-range-track{
    height:2px;background:rgba(242,160,181,.12);border:none;border-radius:1px;
  }

  @keyframes scrollHintBreath{
    0%,100%{opacity:.35;box-shadow:0 0 4px rgba(242,160,181,.1)}
    50%{opacity:.8;box-shadow:0 0 8px rgba(242,160,181,.3)}
  }

  /* ── Nav title ── */
  .nav-title{
    position:fixed;top:1.2rem;left:50%;transform:translateX(-50%);
    z-index:55;
    font-family:'Cormorant Garamond',serif;
    font-size:1.5rem;font-weight:300;font-style:italic;
    color:#d4d8e8;
    text-shadow:
      -1px -1px 0 rgba(10,14,30,.85),
       1px -1px 0 rgba(10,14,30,.85),
      -1px  1px 0 rgba(10,14,30,.85),
       1px  1px 0 rgba(10,14,30,.85),
       0 0 8px rgba(10,14,30,.7),
       0 0 20px rgba(10,14,30,.4);
    opacity:0;
    transition:opacity .5s ease;
    cursor:pointer;
    pointer-events:none;
    user-select:none;-webkit-user-select:none;
  }
  .nav-title.show{opacity:1;pointer-events:auto}
  .nav-title:hover{text-shadow:0 0 12px rgba(212,216,232,.5),0 0 24px rgba(212,216,232,.25)}

  /* ── Reading section ── */
  .reading{
    position:relative;z-index:10;
    padding:8vh 10vw 12vh;
    transition:opacity .5s ease;
  }
  .content{transition:opacity .5s ease}
  .scroll-hint-bottom{
    position:fixed;bottom:1.5rem;left:10vw;transform:none;
    width:40px;height:1px;
    background:rgba(242,160,181,.5);
    z-index:12;
    pointer-events:auto;cursor:pointer;
    opacity:0;
    transition:opacity .6s ease;
  }
  .scroll-hint-bottom.visible{
    opacity:1;
    animation:scrollHintBreath 3s ease-in-out infinite;
  }
  body.scroll-locked{overflow:hidden;touch-action:none}
  body.scroll-unlocking{overflow:auto;touch-action:none}
  body.cursor-chraist-dark,body.cursor-chraist-dark *{cursor:url('assets/chraist/cursor-dark.png') 16 16,default!important}
  body.cursor-chraist-white,body.cursor-chraist-white *{cursor:url('assets/chraist/cursor-white.png') 16 16,default!important}
  .scroll-hint-bottom.chraist-hint{
    width:28px;height:28px;
    background:none;
    background-image:url('assets/chraist/symbol-white.png');
    background-size:contain;
    background-repeat:no-repeat;
    background-position:center;
    transform:scaleY(-1);
  }
  .scroll-hint-bottom.chraist-hint.visible{
    animation:chraistBreath 3s ease-in-out infinite;
  }
  .scroll-hint-bottom.chraist-hint:hover{
    filter:drop-shadow(0 0 10px rgba(242,160,181,.5));opacity:1;
  }
  @keyframes chraistBreath{
    0%,100%{opacity:.35;filter:drop-shadow(0 0 4px rgba(242,160,181,.1))}
    50%{opacity:.8;filter:drop-shadow(0 0 8px rgba(242,160,181,.35))}
  }
  .scroll-hint-bottom.tap-to-scroll::before{
    content:'';position:absolute;
    top:-22px;bottom:-22px;left:-20px;right:-20px;
  }
  body.no-text-border .title,
  body.no-text-border .ac-body,
  body.no-text-border .ac-quote,
  body.no-text-border .essay-view-title,
  body.no-text-border .essay-view-body,
  body.no-text-border .nav-title{text-shadow:none}
  .edit-panel .ep-toggle-row{
    display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem;
  }
  .edit-panel .ep-toggle{
    position:relative;width:28px;height:14px;
    background:rgba(242,160,181,.12);border-radius:7px;
    border:none;cursor:pointer;flex-shrink:0;
    transition:background .3s ease;
  }
  .edit-panel .ep-toggle::after{
    content:'';position:absolute;top:2px;left:2px;
    width:10px;height:10px;border-radius:50%;
    background:rgba(242,160,181,.5);
    transition:transform .3s ease,background .3s ease;
  }
  .edit-panel .ep-toggle.active{background:rgba(242,160,181,.3)}
  .edit-panel .ep-toggle.active::after{transform:translateX(14px);background:rgba(242,160,181,.8)}
  .reading-inner{
    max-width:640px;
  }
  .reading-block{
    margin-bottom:5rem;
  }
  .reading-block:last-child{margin-bottom:0}
  .reading-section-label{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.6rem;letter-spacing:.2em;text-transform:uppercase;
    color:rgba(242,160,181,.5);
    margin-bottom:1rem;
  }
  .reading-section-title{
    font-family:'Cormorant Garamond',serif;
    font-weight:300;font-style:italic;
    font-size:clamp(1.8rem,4vw,2.8rem);
    color:#d4d8e8;
    margin-bottom:1.2rem;
    line-height:1.2;
  }
  .reading-body{
    font-family:'Cormorant Garamond',serif;
    font-weight:300;
    font-size:clamp(.95rem,1.6vw,1.1rem);
    color:#7a84a8;
    line-height:2;
    max-width:500px;
  }
  .reading-link-list{
    list-style:none;padding:0;
  }
  .reading-link-list li{
    margin-bottom:.6rem;
  }
  .reading-link-list a{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.8rem;
    color:rgba(242,160,181,.7);
    text-decoration:underline;
    text-decoration-color:rgba(242,160,181,.2);
    text-underline-offset:3px;
    transition:color .3s ease, text-decoration-color .3s ease;
    letter-spacing:.03em;
    position:relative;
  }
  .reading-link-list a::before{
    content:'';position:absolute;
    top:-10px;bottom:-10px;left:-14px;right:-14px;
  }
  .reading-link-list a:hover{
    color:rgba(242,160,181,1);
    text-decoration-color:rgba(242,160,181,.5);
  }
  .countdown{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.65rem;
    color:rgba(242,160,181,.45);
    letter-spacing:.05em;
  }
  .essay-premiere{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.55rem;
    color:rgba(242,160,181,.35);
    letter-spacing:.06em;
  }
  .essay-date{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.55rem;
    color:rgba(242,160,181,.3);
    letter-spacing:.04em;
  }
  .essay-draft{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.55rem;
    color:rgba(242,160,181,.35);
    letter-spacing:.12em;
    text-transform:uppercase;
  }

  /* ── Draft popup ── */
  .draft-overlay{
    position:fixed;inset:0;z-index:200;
    display:flex;align-items:center;justify-content:center;
    background:rgba(6,9,18,.85);
    opacity:0;pointer-events:none;
    transition:opacity .4s ease;
    -webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);
  }
  .draft-overlay.open{opacity:1;pointer-events:auto}
  .draft-popup{
    text-align:center;padding:2.5rem 2rem;
    max-width:420px;width:90vw;position:relative;
  }
  .draft-close{
    position:absolute;top:1rem;right:1rem;
    width:28px;height:28px;
    border:1px solid rgba(242,160,181,.15);border-radius:50%;
    background:none;color:rgba(242,160,181,.5);
    font-family:'SF Mono',monospace;font-size:.7rem;
    cursor:pointer;display:flex;align-items:center;justify-content:center;
    transition:border-color .3s,color .3s;
  }
  .draft-close:hover,.draft-close.tap-glow{border-color:rgba(242,160,181,.4);color:rgba(242,160,181,.8);box-shadow:0 0 10px rgba(242,160,181,.3)}
  .draft-title{
    font-family:'Cormorant Garamond',serif;
    font-weight:300;font-style:italic;
    font-size:1.8rem;letter-spacing:.08em;
    color:rgba(242,160,181,.85);
    margin-bottom:1.5rem;
  }
  .draft-line{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.7rem;letter-spacing:.06em;
    color:rgba(242,160,181,.55);
    margin:0 0 .4rem;line-height:1.6;
  }
  .draft-timer{
    margin-top:1.5rem;
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.85rem;letter-spacing:.08em;
    color:rgba(242,160,181,.7);
  }

  /* ── Site footer ── */
  .site-footer{
    position:relative;z-index:10;
    padding:4vh 10vw 6vh;
    transition:opacity .5s ease;
  }
  @media (hover:none) and (pointer:coarse){
    .site-footer{padding-bottom:10vh}
  }
  .site-footer-text{
    font-family:'SF Mono','Fira Code','Cascadia Code','Consolas',monospace;
    font-size:.55rem;letter-spacing:.04em;
    color:rgba(242,160,181,.4);
    line-height:1.8;
  }

  /* ── Tooltip ── */
  .tooltip-wrap{
    position:relative;
    display:inline;
    cursor:text;
    transition:color .35s ease, text-shadow .35s ease;
    padding:20px;margin:-20px;
  }
  .tooltip-wrap:hover,
  .tooltip-wrap.tapped{
    color:rgba(242,160,181,.85);
    text-shadow:0 0 8px rgba(242,160,181,.4),0 0 16px rgba(242,160,181,.2);
  }
  .tooltip-text{
    position:absolute;
    bottom:calc(100% + 10px);left:50%;transform:translateX(-50%);
    font-family:'Cormorant Garamond',serif;
    font-weight:300;font-style:italic;
    font-size:.85rem;letter-spacing:.06em;
    color:rgba(242,160,181,.8);
    white-space:nowrap;
    opacity:0;
    transition:opacity .35s ease;
    pointer-events:none;
  }
  @media (hover:none) and (pointer:coarse){
    .tooltip-text{bottom:calc(100% + 18px);font-size:.95rem}
  }
  .tooltip-wrap:hover .tooltip-text,
  .tooltip-wrap.tapped .tooltip-text{
    opacity:1;
  }
</style>
</head>
<body>
<div class="grain"><canvas id="grain"></canvas></div>
<canvas id="scene"></canvas>
<div class="moonlight" id="moon"></div>
<div class="vignette"></div>

<nav class="nav-title" id="navTitle">Suntzugi</nav>

<button class="audio-btn" id="audioBtn" aria-label="Toggle music">
  <canvas id="audioWave" width="24" height="24"></canvas>
</button>
<audio id="bgMusic" loop preload="auto"></audio>
<div class="now-playing" id="nowPlaying">
  <div class="np-label"><span class="np-dot"></span>playing</div>
  <div class="np-info" id="npInfo">
    <div class="np-title" id="npTitle"></div>
    <div class="np-artist" id="npArtist"></div>
  </div>
</div>
<div class="song-picker" id="songPicker"></div>

<div class="edit-panel" id="editPanel">
  <div class="ep-header">
    <div>
      <div class="ep-title">tree parameters</div>
      <div class="ep-presets" id="epPresets"></div>
    </div>
    <button class="ep-close" id="epClose">0</button>
  </div>
  <div class="ep-group">
    <div class="ep-group-title">1. Shadow</div>
    <div class="ep-slider-row"><span class="ep-num">1</span><div class="ep-slider-wrap"><div class="ep-slider-info"><span class="ep-slider-name">shadow darkness</span><span class="ep-slider-val" id="val-shadowDarkness">2.40</span></div><input type="range" min="0.2" max="3.0" step="0.05" value="2.4" data-param="shadowDarkness"></div></div>
    <div class="ep-slider-row"><span class="ep-num">2</span><div class="ep-slider-wrap"><div class="ep-slider-info"><span class="ep-slider-name">shadow blur</span><span class="ep-slider-val" id="val-shadowBlur">0.45</span></div><input type="range" min="0.2" max="3.0" step="0.05" value="0.45" data-param="shadowBlur"></div></div>
  </div>
  <div class="ep-group">
    <div class="ep-group-title">2. Animation</div>
    <div class="ep-slider-row"><span class="ep-num">3</span><div class="ep-slider-wrap"><div class="ep-slider-info"><span class="ep-slider-name">draw speed</span><span class="ep-slider-val" id="val-drawSpeed">1.00</span></div><input type="range" min="0.3" max="3.0" step="0.05" value="1.0" data-param="drawSpeed"></div></div>
    <div class="ep-slider-row"><span class="ep-num">4</span><div class="ep-slider-wrap"><div class="ep-slider-info"><span class="ep-slider-name">bloom speed</span><span class="ep-slider-val" id="val-bloomSpeed">1.00</span></div><input type="range" min="0.3" max="3.0" step="0.05" value="1.0" data-param="bloomSpeed"></div></div>
    <div class="ep-slider-row"><span class="ep-num">5</span><div class="ep-slider-wrap"><div class="ep-slider-info"><span class="ep-slider-name">petal fade rate</span><span class="ep-slider-val" id="val-petalFadeRate">1.00</span></div><input type="range" min="0.3" max="3.0" step="0.05" value="1.0" data-param="petalFadeRate"></div></div>
  </div>
  <div class="ep-group">
    <div class="ep-group-title">3. Tree Shape</div>
    <div class="ep-slider-row"><span class="ep-num">6</span><div class="ep-slider-wrap"><div class="ep-slider-info"><span class="ep-slider-name">trunk thickness</span><span class="ep-slider-val" id="val-trunkThickness">1.00</span></div><input type="range" min="0.5" max="2.0" step="0.05" value="1.0" data-param="trunkThickness"></div></div>
    <div class="ep-slider-row"><span class="ep-num">7</span><div class="ep-slider-wrap"><div class="ep-slider-info"><span class="ep-slider-name">branch spread</span><span class="ep-slider-val" id="val-branchSpread">1.00</span></div><input type="range" min="0.3" max="2.0" step="0.05" value="1.0" data-param="branchSpread"></div></div>
    <div class="ep-slider-row"><span class="ep-num">8</span><div class="ep-slider-wrap"><div class="ep-slider-info"><span class="ep-slider-name">max depth</span><span class="ep-slider-val" id="val-maxDepth">5</span></div><input type="range" min="3" max="7" step="1" value="5" data-param="maxDepth"></div></div>
    <div class="ep-slider-row"><span class="ep-num">9</span><div class="ep-slider-wrap"><div class="ep-slider-info"><span class="ep-slider-name">branch density</span><span class="ep-slider-val" id="val-branchDensity">1.00</span></div><input type="range" min="0.5" max="2.0" step="0.05" value="1.0" data-param="branchDensity"></div></div>
    <div class="ep-slider-row"><span class="ep-num">10</span><div class="ep-slider-wrap"><div class="ep-slider-info"><span class="ep-slider-name">tree height</span><span class="ep-slider-val" id="val-treeHeight">1.00</span></div><input type="range" min="0.3" max="2.0" step="0.05" value="1.0" data-param="treeHeight"></div></div>
    <div class="ep-slider-row"><span class="ep-num">11</span><div class="ep-slider-wrap"><div class="ep-slider-info"><span class="ep-slider-name">tree width</span><span class="ep-slider-val" id="val-treeWidth">1.00</span></div><input type="range" min="0.3" max="2.0" step="0.05" value="1.0" data-param="treeWidth"></div></div>
    <div class="ep-slider-row"><span class="ep-num"></span><div class="ep-slider-wrap"><div class="ep-slider-name" style="margin-bottom:.3rem">tree style</div><div class="ep-styles" id="epStyles"></div></div></div>
  </div>
  <div class="ep-group">
    <div class="ep-group-title">4. Petals</div>
    <div class="ep-slider-row"><span class="ep-num">12</span><div class="ep-slider-wrap"><div class="ep-slider-info"><span class="ep-slider-name">petal density</span><span class="ep-slider-val" id="val-petalDensity">1.00</span></div><input type="range" min="0.3" max="2.0" step="0.05" value="1.0" data-param="petalDensity"></div></div>
    <div class="ep-slider-row"><span class="ep-num">13</span><div class="ep-slider-wrap"><div class="ep-slider-info"><span class="ep-slider-name">glow intensity</span><span class="ep-slider-val" id="val-glowIntensity">1.00</span></div><input type="range" min="0" max="3.0" step="0.05" value="1.0" data-param="glowIntensity"></div></div>
  </div>
  <div class="ep-group">
    <div class="ep-group-title">5. Typography</div>
    <div class="ep-toggle-row"><button class="ep-toggle" id="toggleTextBorder"></button><span class="ep-slider-name">text border</span></div>
  </div>
  <div class="ep-group">
    <div class="ep-group-title">6. Scroll Pointer</div>
    <div class="ep-toggle-row"><button class="ep-toggle" id="toggleChraistHint"></button><span class="ep-slider-name">chraist symbol</span></div>
  </div>
  <div class="ep-group">
    <div class="ep-group-title">7. Cursor</div>
    <div class="ep-slider-row"><span class="ep-num"></span><div class="ep-slider-wrap"><div class="ep-styles" id="epCursorStyles"></div></div></div>
  </div>
</div>

<div class="content"><div class="ci">

  <div class="hover-zone" id="hoverZone">
  <h1 class="title" id="title"><span class="syl" data-i="0">Sun</span><span class="syl" data-i="1">tzu</span><span class="syl" data-i="2">gi</span></h1>

  <div class="anno-zone" id="annoZone">

    <!-- Single: Sun -->
    <div class="anno-card" id="card-sun">
      <div class="ac-top">
        <span class="ac-char">孫</span>
        <span class="ac-label">sūn · chinese — grandchild, descedant</span>
      </div>
      <div class="ac-body">
        The sun is the star that gave life to everything on earth. Different traditions throughout our human history have worshipped the sun for bringing light to the dark and life to the dead. All calendars and religious holidays are mapped to the stars and the cycles caused by the sun, even the moon cycles exist because of the light reflected by the sun on the moon. Many people have begun to call me sun on twitter as an abbreviation for Suntzoogway and Suntzugi, this wasn't planned, but I take it in stride as I see symbolically as others choosing to call me a bringer of light and warmth; I endeavour to do so.
      </div>
      <div class="ac-body" style="margin-top:.4rem">
        Interestingly in Chinese, sūn 孫 means grandchild, descendant. The english language mirrors this beautifully with the homonym son. As the son of the sun, I hope to do this beautiful word, I have been bestowed as a name by my twitter friends, justice and keep my inner child's curiosity and wonder alive.
      </div>
      <div class="ac-quote">
        "Truly I tell you, unless you change and become like little children, you will never enter the kingdom of heaven."
        <span class="attr">— <a href="https://www.biblegateway.com/passage/?search=Matthew%2018%3A3&version=NIV" target="_blank">Matthew 18:3</a></span>
      </div>
    </div>

    <!-- Single: tzu -->
    <div class="anno-card" id="card-tzu">
      <div class="ac-top">
        <span class="ac-char">子</span>
        <span class="ac-label">zǐ · chinese — master, child</span>
      </div>
      <div class="ac-body">
        In Chinese Tzu is a title meaning Master. To learn is to master, and the eternal master remains forever a student.
      </div>
    </div>

    <!-- Single: gi -->
    <div class="anno-card" id="card-gi">
      <div class="ac-top">
        <span class="ac-char">龜</span>
        <span class="ac-label">guī · chinese — turtle</span>
      </div>
      <div class="ac-body">
        The turtle — patient building that scales exponentially on a solid foundation.
        In myth, the turtle carries the world on its back — reality itself resting on quiet endurance.
        Home is wherever you are, because you carry it with you.
        Move with grace and fix things — not fast and break things like the rabbit of Silicon Valley.
      </div>
    </div>

    <!-- Compound: SunTzu -->
    <div class="anno-card" id="card-suntzu">
      <div class="ac-top">
        <span class="ac-char">孫子</span>
        <span class="ac-label">sūn zǐ · chinese — the art of war</span>
      </div>
      <div class="ac-body">
        The ancient Chinese strategist who taught that the greatest victory comes without violence.
      </div>
      <div class="ac-quote">
        "To win one hundred victories in one hundred battles is not the acme of skill. To subdue the enemy without fighting is the acme of skill."
        <span class="attr">— Sun Tzu, The Art of War (Samuel B. Griffith translation, 1963)</span>
      </div>
    </div>

    <!-- Compound: Tzugi -->
    <div class="anno-card" id="card-tzugi">
      <div class="ac-top">
        <span class="ac-char">継ぎ · 子龜</span>
        <span class="ac-label">tsugi (japanese) · zǐ guī (chinese) — to repair · master turtle</span>
      </div>
      <div class="ac-body">
        Tsugi 継ぎ — to mend, to continue, to join what was broken. In Japanese,
        it is the heart of kintsugi 金継ぎ, the art of repairing broken pottery with
        gold — making the fracture part of the beauty, not something to hide.
        The break becomes the most luminous part.
      </div>
      <div class="ac-sep"></div>
      <div class="ac-body">
        But Tzu Gui is also Master Turtle — 子龜. An echo of Master Oogway, the
        tortoise who saw potential where no one else looked. Sun grew up as Po —
        the passionate outsider with no secret ingredient, no lineage, no traditional
        path. Just earnest, stubborn love for the craft. And that was always enough
        to become the Dragon Warrior. But time turns Po into Oogway — the one who
        must now lead, who must help others ascend the same mountain. Before this
        name there was <a href="https://x.com/suntzoogway" target="_blank">Suntzoogway</a> —
        Suntzugi is the abbreviation, the neologism, the next chapter.
      </div>
    </div>

    <!-- Full word: Suntzugi -->
    <div class="anno-card" id="card-full">
      <div class="ac-top">
        <span class="ac-char">Suntzugi</span>
        <span class="ac-label">the philosophy and the man</span>
      </div>
      <div class="ac-body">
        Mastering the art of repairing with light —
        the belief that the world can be mended with love,
        just as the sun brought life to earth from its
        quiet position in the heavens. A neologism built from
        Chinese, Japanese, and the memory of a turtle who
        carried everything on his back and kept walking.
      </div>
      <div class="ac-body" style="margin-top:.5rem">
        <a href="https://x.com/suntzugi" target="_blank">@suntzugi</a>
      </div>
    </div>

  </div>
  </div><!-- end hover-zone -->

</div></div>

<section class="reading" id="readingSection">
  <div class="reading-inner">
    <div class="reading-block" id="publishedBlock" style="display:none">
      <div class="reading-section-label">published</div>
      <ul class="reading-link-list" id="publishedList"></ul>
    </div>
    <div class="reading-block" id="draftsBlock">
      <div class="reading-section-label">currently being written</div>
      <ul class="reading-link-list" id="draftsList">
        <li data-draft><a href="#" data-essay="my-time-has-come">My Time Has Come</a> <span class="countdown" data-target="2026-02-22T03:33:00+01:00"></span></li>
      </ul>
    </div>
    <div class="reading-block">
      <div class="reading-section-label">links</div>
      <ul class="reading-link-list">
        <li><a href="https://x.com/suntzugi" target="_blank">Twitter</a></li>
        <li><a href="mailto:suntzoogway@gmail.com">Email</a></li>
        <li><a href="https://lovepill.org" target="_blank">Lovepill AI</a></li>
        <li><a href="https://chraist.ai" target="_blank">Chraist</a></li>
        <li><a href="https://github.com/suntzugi" target="_blank">Github</a></li>
        <li><a href="https://substack.com/@suntzugi" target="_blank">Substack</a> <span class="essay-premiere">premiere <span class="countdown" data-target="2026-02-23T17:55:00-08:00"></span></span></li>
        <li><a href="#neodore" data-neodore>Neodore (stealth)</a> <span class="countdown" data-target="2026-02-27T08:17:00-08:00"></span></li>
      </ul>
    </div>
  </div>
</section>
<footer class="site-footer" id="siteFooter">
  <div class="site-footer-text">This site was first made and published with <span class="tooltip-wrap" id="tooltipWrap"><span class="tooltip-text">Love</span>positive sum qualia</span> on <span class="tooltip-wrap" id="tooltipDate"><span class="tooltip-text">Nac&iacute; el veinte de Febrero</span>20/02/26</span>.</div>
</footer>
<div class="scroll-hint-bottom"></div>

<div class="essay-view" id="essayView">
  <div class="essay-view-inner">
    <h2 class="essay-view-title" id="essayTitle"></h2>
    <div class="essay-view-body" id="essayBody"></div>
  </div>
</div>

<div class="neodore-overlay" id="neodoreOverlay">
  <div class="neodore-popup">
    <div class="neodore-close" id="neodoreClose">0</div>
    <h2 class="neodore-title">Neodore</h2>
    <p class="neodore-line">The present present production company.</p>
    <p class="neodore-line">The good company.</p>
    <p class="neodore-line">The first alignment company.</p>
    <p class="neodore-line">The mettalignment R&D lab.</p>
    <div class="neodore-timer"><span class="countdown" data-target="2026-02-27T08:17:00-08:00"></span></div>
    <div class="neodore-soon">launching soon</div>
    <p class="neodore-contact"><a href="https://x.com/suntzugi" target="_blank">follow me on twitter</a> or <a href="mailto:suntzoogway@gmail.com">email me</a> to be notified</p>
  </div>
</div>

<div class="draft-overlay" id="draftOverlay">
  <div class="draft-popup">
    <div class="draft-close" id="draftClose">0</div>
    <h2 class="draft-title" id="draftPopupTitle"></h2>
    <p class="draft-line">Current draft being written.</p>
    <div class="draft-timer"><span class="countdown" id="draftPopupCountdown"></span></div>
  </div>
</div>

<script>
// ── Annotation hover system ──
(function(){
  const syls = document.querySelectorAll('.syl');
  const zone = document.getElementById('hoverZone');
  const cards = {
    sun: document.getElementById('card-sun'),
    tzu: document.getElementById('card-tzu'),
    gi: document.getElementById('card-gi'),
    suntzu: document.getElementById('card-suntzu'),
    tzugi: document.getElementById('card-tzugi'),
    full: document.getElementById('card-full'),
  };

  let activeCard = null;
  let hoverHistory = [];
  let leaveTimer = null;
  let insideZone = false;

  function showCard(name){
    if(activeCard === name) return;
    Object.values(cards).forEach(c => { c.classList.remove('show','scroll-glow'); c.scrollTop = 0; });
    if(cards[name]){
      const c=cards[name];
      c.scrollTop = 0;
      c.classList.add('show');
      activeCard = name;
      // Glow the scrollbar if card content overflows
      requestAnimationFrame(()=>{
        if(c.scrollHeight>c.clientHeight){
          c.classList.add('scroll-glow');
          setTimeout(()=>c.classList.remove('scroll-glow'),1300);
        }
      });
    }
  }

  function hideAll(){
    Object.values(cards).forEach(c => c.classList.remove('show','scroll-glow'));
    syls.forEach(s => s.classList.remove('lit'));
    activeCard = null;
    hoverHistory = [];
  }

  function evaluateState(currentSyl){
    const now = Date.now();
    const recent = hoverHistory.filter(h => now - h.time < 1200);
    const indices = new Set(recent.map(h => h.index));

    if(indices.has(0) && indices.has(1) && indices.has(2)){
      syls.forEach(s => s.classList.add('lit'));
      showCard('full'); return;
    }
    if(activeCard === 'suntzu' && currentSyl === 2){
      hoverHistory.push({index:2, time:now});
      syls.forEach(s => s.classList.add('lit'));
      showCard('full'); return;
    }
    if(activeCard === 'tzugi' && currentSyl === 0){
      hoverHistory.push({index:0, time:now});
      syls.forEach(s => s.classList.add('lit'));
      showCard('full'); return;
    }
    if(indices.has(0) && indices.has(1)){
      syls[0].classList.add('lit'); syls[1].classList.add('lit');
      syls[2].classList.remove('lit');
      showCard('suntzu'); return;
    }
    if(activeCard === 'sun' && currentSyl === 1){
      hoverHistory.push({index:0, time:now});
      syls[0].classList.add('lit'); syls[1].classList.add('lit');
      syls[2].classList.remove('lit');
      showCard('suntzu'); return;
    }
    if(indices.has(1) && indices.has(2)){
      syls[1].classList.add('lit'); syls[2].classList.add('lit');
      syls[0].classList.remove('lit');
      showCard('tzugi'); return;
    }
    if(activeCard === 'tzu' && currentSyl === 2){
      hoverHistory.push({index:1, time:now});
      syls[1].classList.add('lit'); syls[2].classList.add('lit');
      syls[0].classList.remove('lit');
      showCard('tzugi'); return;
    }

    syls.forEach((s,j) => j===currentSyl ? s.classList.add('lit') : s.classList.remove('lit'));
    showCard(['sun','tzu','gi'][currentSyl]);
  }

  syls.forEach((el, i) => {
    el.addEventListener('mouseenter', () => {
      if(leaveTimer){clearTimeout(leaveTimer);leaveTimer=null}
      hoverHistory.push({index:i, time:Date.now()});
      if(hoverHistory.length > 12) hoverHistory = hoverHistory.slice(-8);
      evaluateState(i);
    });
  });

  zone.addEventListener('mouseenter', () => {
    insideZone = true;
    if(leaveTimer){clearTimeout(leaveTimer);leaveTimer=null}
  });

  zone.addEventListener('mouseleave', () => {
    insideZone = false;
    leaveTimer = setTimeout(() => {
      if(!insideZone) hideAll();
    }, 500);
  });

  syls.forEach((el, i) => {
    el.addEventListener('touchstart', (e) => {
      e.preventDefault();
      if(leaveTimer){clearTimeout(leaveTimer);leaveTimer=null}
      insideZone = true;
      hoverHistory.push({index:i, time:Date.now()});
      if(hoverHistory.length > 12) hoverHistory = hoverHistory.slice(-8);
      evaluateState(i);
    }, {passive:false});
  });

  document.addEventListener('touchstart', (e) => {
    if(activeCard && !zone.contains(e.target)){
      hideAll();
    }
  }, {passive:true});

  // ── Touch slide: finger drag across syllables ──
  let lastTouchSyl = -1;
  let lastTouchTime = 0;

  document.addEventListener('touchmove', (e) => {
    const touch = e.touches[0];
    if(!touch) return;
    const el = document.elementFromPoint(touch.clientX, touch.clientY);
    if(!el) return;
    const syl = el.closest('.syl');
    if(syl){
      e.preventDefault();
      const i = parseInt(syl.dataset.i, 10);
      if(leaveTimer){clearTimeout(leaveTimer);leaveTimer=null}
      insideZone = true;
      const now = Date.now();
      if(i !== lastTouchSyl || now - lastTouchTime > 100){
        lastTouchSyl = i;
        lastTouchTime = now;
        hoverHistory.push({index:i, time:now});
        if(hoverHistory.length > 12) hoverHistory = hoverHistory.slice(-8);
        evaluateState(i);
      }
    } else {
      lastTouchSyl = -1;
    }
  }, {passive:false});

  document.addEventListener('touchend', () => {
    lastTouchSyl = -1;
  }, {passive:true});
})();
</script>

<script>
// ── Essay loader — fetches essays/{slug}.md, falls back to inline ──
const essayCache={};

// Inline fallback (works on file:// protocol where fetch fails)
const essayFallback={};

function parseMd(md){
  const lines=md.split('\n');
  let title='',bodyLines=[];
  let written='',edited='';
  let pastTitle=false,pastMeta=false;
  for(const line of lines){
    if(!pastTitle&&line.startsWith('# ')){
      title=line.slice(2).trim();
      pastTitle=true;
      continue;
    }
    if(pastTitle&&!pastMeta){
      const wm=line.match(/^Written:\s*(.+)/i);
      const em=line.match(/^Last edited:\s*(.+)/i);
      if(wm){written=wm[1].trim();continue;}
      if(em){edited=em[1].trim();continue;}
      if(line.trim()==='')continue;
      pastMeta=true;
    }
    if(pastTitle) bodyLines.push(line);
  }
  const raw=bodyLines.join('\n').trim();
  let body=raw.split(/\n\n+/).map(block=>{
    let html=block.replace(/\n/g,' ')
      .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
      .replace(/\*(.+?)\*/g,'<em>$1</em>')
      .replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>');
    return '<p>'+html+'</p>';
  }).join('\n');
  if(written||edited){
    let meta='<div class="essay-meta">';
    if(written) meta+='<span>written: '+written+'</span>';
    if(written&&edited) meta+=' · ';
    if(edited) meta+='<span>last edited: '+edited+'</span>';
    meta+='</div>';
    body+='\n'+meta;
  }
  return {title,body};
}

async function loadEssay(slug){
  if(essayCache[slug]) return essayCache[slug];
  try{
    const res=await fetch('texts/essays/'+slug+'.md');
    if(res.ok){
      const md=await res.text();
      const parsed=parseMd(md);
      essayCache[slug]=parsed;
      return parsed;
    }
  }catch(e){/* fetch fails on file:// — fall through */}
  // Fallback to inline data
  if(essayFallback[slug]){
    essayCache[slug]=essayFallback[slug];
    return essayFallback[slug];
  }
  return null;
}
</script>

<script>
// ── Suntzugi content loader — extracts text from texts/suntzugi/content.md ──
(function(){
  const cardMap={
    'Card 1: Sun':'card-sun',
    'Card 2: Tzu':'card-tzu',
    'Card 3: Gi':'card-gi',
    'Card 4: SunTzu':'card-suntzu',
    'Card 5: Tzugi':'card-tzugi',
    'Card 6: Suntzugi':'card-full'
  };

  function parseContentMd(md){
    const sections={};
    const blocks=md.split(/^## /m).slice(1);
    for(const block of blocks){
      const lines=block.split('\n');
      const heading=lines[0].trim();
      const body=lines.slice(1).join('\n');
      sections[heading]=body;
    }
    return sections;
  }

  function extractField(text,field){
    const re=new RegExp('\\*\\*'+field+':\\*\\*\\s*(.+?)(?=\\n\\n\\*\\*|\\n---|\\_$)','s');
    const m=text.match(re);
    return m?m[1].trim():null;
  }

  function mdInline(s){
    if(!s)return '';
    return s.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>')
            .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
            .replace(/\*(.+?)\*/g,'<em>$1</em>');
  }

  function applyCard(id,section){
    const el=document.getElementById(id);
    if(!el)return;

    const character=extractField(section,'Character');
    const label=extractField(section,'Label');
    const body=extractField(section,'Body');
    const bodyP1=extractField(section,'Body Part 1');
    const bodyP2=extractField(section,'Body Part 2');
    const quote=extractField(section,'Quote');
    const quoteAttr=extractField(section,'Quote Attribution');
    const link=extractField(section,'Link');

    if(character){
      const charEl=el.querySelector('.ac-char');
      if(charEl) charEl.textContent=character;
    }
    if(label){
      const labelEl=el.querySelector('.ac-label');
      if(labelEl) labelEl.textContent=label;
    }

    // Collect all .ac-body and .ac-quote elements
    const bodies=el.querySelectorAll('.ac-body');
    const quotes=el.querySelectorAll('.ac-quote');
    const seps=el.querySelectorAll('.ac-sep');

    if(bodyP1&&bodyP2){
      // Two-part body (e.g. Tzugi card)
      if(bodies[0]) bodies[0].innerHTML=mdInline(bodyP1);
      if(bodies[1]) bodies[1].innerHTML=mdInline(bodyP2);
    } else if(body){
      const paragraphs=body.split(/\n\n+/);
      // Fill existing .ac-body divs
      for(let i=0;i<bodies.length&&i<paragraphs.length;i++){
        bodies[i].innerHTML=mdInline(paragraphs[i]);
      }
      // Create additional .ac-body divs if more paragraphs than existing
      if(paragraphs.length>bodies.length){
        const anchor=el.querySelector('.ac-quote')||el.querySelector('.ac-sep');
        for(let i=bodies.length;i<paragraphs.length;i++){
          const div=document.createElement('div');
          div.className='ac-body';
          div.style.marginTop='.4rem';
          div.innerHTML=mdInline(paragraphs[i]);
          if(anchor) el.insertBefore(div,anchor);
          else el.appendChild(div);
        }
      }
    }

    if(quote&&quotes[0]){
      quotes[0].innerHTML=mdInline(quote)+(quoteAttr?'\n<span class="attr">— '+mdInline(quoteAttr)+'</span>':'');
    }

    if(link){
      // Find or create the link body element
      const linkBody=bodies[bodies.length-1];
      if(linkBody&&linkBody.querySelector('a')){
        linkBody.innerHTML=mdInline(link);
      }
    }
  }

  function parseMarkdownLinks(text){
    const links=[];
    const re=/\[([^\]]+)\]\(([^)]+)\)/g;
    let m;
    while((m=re.exec(text))!==null) links.push({label:m[1],url:m[2]});
    return links;
  }

  function applyEssays(section){
    const entries=[];
    const lines=section.split('\n').filter(l=>l.trim().startsWith('- ['));
    for(const line of lines){
      const linkMatch=line.match(/\[([^\]]+)\]\(([^)]+)\)/);
      if(!linkMatch)continue;
      const entry={label:linkMatch[1],url:linkMatch[2]};
      const dm=line.match(/\{date:([^}]+)\}/);
      if(dm) entry.date=dm[1].trim();
      const sm=line.match(/\{status:([^}]+)\}/);
      if(sm) entry.status=sm[1].trim();
      const cm=line.match(/\{countdown:([^}]+)\}/);
      if(cm) entry.countdown=cm[1].trim();
      entries.push(entry);
    }
    if(!entries.length)return;
    const published=entries.filter(l=>l.status!=='draft');
    const drafts=entries.filter(l=>l.status==='draft');
    const pubBlock=document.getElementById('publishedBlock');
    const pubList=document.getElementById('publishedList');
    const draftBlock=document.getElementById('draftsBlock');
    const draftList=document.getElementById('draftsList');

    function renderEntry(l){
      const hashMatch=l.url.match(/^#(.+)$/);
      const slug=hashMatch?hashMatch[1]:l.label.toLowerCase().replace(/\s+/g,'-');
      const isDraft=l.status==='draft';
      let html='<li'+(isDraft?' data-draft':'')+'><a href="#" data-essay="'+slug+'">'+l.label+'</a>';
      if(!isDraft&&l.date) html+=' <span class="essay-date">'+l.date+'</span>';
      if(l.countdown) html+=' <span class="countdown" data-target="'+l.countdown+'"></span>';
      html+='</li>';
      return html;
    }

    if(pubBlock&&pubList){
      if(published.length){
        pubList.innerHTML=published.map(renderEntry).join('');
        pubBlock.style.display='';
      } else {
        pubBlock.style.display='none';
      }
    }
    if(draftBlock&&draftList){
      if(drafts.length){
        draftList.innerHTML=drafts.map(renderEntry).join('');
        draftBlock.style.display='';
      } else {
        draftBlock.style.display='none';
      }
    }
    startCountdowns();
  }

  function parseLinksWithMeta(section){
    const results=[];
    const lines=section.split('\n').filter(l=>l.trim().startsWith('- ['));
    for(const line of lines){
      const linkMatch=line.match(/\[([^\]]+)\]\(([^)]+)\)/);
      if(!linkMatch)continue;
      const entry={label:linkMatch[1],url:linkMatch[2]};
      const cdMatch=line.match(/\{countdown:([^}]+)\}/);
      if(cdMatch) entry.countdown=cdMatch[1].trim();
      const spMatch=line.match(/\{substack-premiere:([^}]+)\}/);
      if(spMatch) entry.premiere=spMatch[1].trim();
      results.push(entry);
    }
    return results;
  }

  function applyLinks(section){
    const links=parseLinksWithMeta(section);
    if(!links.length)return;
    const blocks=document.querySelectorAll('.reading-block');
    for(const block of blocks){
      const label=block.querySelector('.reading-section-label');
      if(label&&label.textContent.trim().toLowerCase()==='links'){
        const ul=block.querySelector('ul');
        if(!ul)break;
        ul.innerHTML=links.map(l=>{
          const isMailto=l.url.startsWith('mailto:');
          const isHash=l.url==='#'||l.url.startsWith('#');
          const target=(!isMailto&&!isHash)?' target="_blank"':'';
          let html='<li><a href="'+l.url+'"'+target+'>'+l.label+'</a>';
          if(l.premiere) html+=' <span class="essay-premiere">premiere <span class="countdown" data-target="'+l.premiere+'"></span></span>';
          if(l.countdown) html+=' <span class="countdown" data-target="'+l.countdown+'"></span>';
          html+='</li>';
          return html;
        }).join('');
        startCountdowns();
        break;
      }
    }
  }

  let countdownInterval=null;
  window.startCountdowns=startCountdowns;
  function startCountdowns(){
    const els=document.querySelectorAll('.countdown[data-target]');
    if(!els.length)return;
    if(countdownInterval){clearInterval(countdownInterval);countdownInterval=null;}
    function tick(){
      const now=Date.now();
      els.forEach(el=>{
        const target=new Date(el.dataset.target).getTime();
        const diff=target-now;
        if(diff<=0){el.textContent='launched';return;}
        const d=Math.floor(diff/86400000);
        const h=Math.floor((diff%86400000)/3600000);
        const m=Math.floor((diff%3600000)/60000);
        const s=Math.floor((diff%60000)/1000);
        el.textContent=d+'d '+String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
      });
    }
    tick();
    countdownInterval=setInterval(tick,1000);
  }

  function applyAudioTracks(section){
    // Parse markdown table rows: | # | Title | Artist |
    const rows=section.split('\n').filter(r=>/^\|/.test(r)&&!/^[\|\s-]+$/.test(r));
    // Skip header row
    const dataRows=rows.slice(1);
    const newTracks=[];
    for(const row of dataRows){
      const cells=row.split('|').map(c=>c.trim()).filter(Boolean);
      if(cells.length>=3){
        const title=cells[1];
        const artist=cells[2];
        newTracks.push(title+'_'+artist+'.mp3');
      }
    }
    if(newTracks.length&&typeof window.__updateTracks==='function'){
      window.__updateTracks(newTracks);
    }
  }

  async function loadContent(){
    try{
      const res=await fetch('texts/suntzugi/content.md');
      if(!res.ok)return;
      const md=await res.text();
      const sections=parseContentMd(md);

      for(const[heading,cardId] of Object.entries(cardMap)){
        // Match section headings that start with the card name
        const key=Object.keys(sections).find(k=>k.startsWith(heading));
        if(key) applyCard(cardId,sections[key]);
      }

      // Apply essays, links, and audio tracks
      if(sections['Essays']) applyEssays(sections['Essays']);
      if(sections['Links']) applyLinks(sections['Links']);
      if(sections['Audio Tracks']) applyAudioTracks(sections['Audio Tracks']);
    }catch(e){/* fetch fails on file:// — HTML fallback stays */}
  }

  loadContent().then(()=>startCountdowns());
  // Also start countdowns for HTML fallback (file:// where fetch fails)
  startCountdowns();
})();
</script>

<script>
// ── Neodore popup ──
(function(){
  const overlay=document.getElementById('neodoreOverlay');
  const closeBtn=document.getElementById('neodoreClose');
  if(!overlay)return;

  document.addEventListener('click',e=>{
    const link=e.target.closest('a[href="#neodore"]');
    if(!link)return;
    e.preventDefault();
    overlay.classList.add('open');
  });

  closeBtn.addEventListener('click',()=>overlay.classList.remove('open'));
  overlay.addEventListener('click',e=>{
    if(e.target===overlay) overlay.classList.remove('open');
  });
  document.addEventListener('keydown',e=>{
    if(e.key==='Escape'&&overlay.classList.contains('open')){e.preventDefault();overlay.classList.remove('open')}
  });
})();
</script>

<script>
// ── Draft popup ──
(function(){
  const overlay=document.getElementById('draftOverlay');
  const closeBtn=document.getElementById('draftClose');
  if(!overlay)return;
  closeBtn.addEventListener('click',()=>overlay.classList.remove('open'));
  overlay.addEventListener('click',e=>{
    if(e.target===overlay) overlay.classList.remove('open');
  });
  document.addEventListener('keydown',e=>{
    if(e.key==='Escape'&&overlay.classList.contains('open')){e.preventDefault();overlay.classList.remove('open')}
  });
})();
</script>

<script>
// ── Close button tap glow (mobile feedback) ──
(function(){
  document.querySelectorAll('.neodore-close,.draft-close,.ep-close').forEach(btn=>{
    btn.addEventListener('touchstart',()=>{
      btn.classList.add('tap-glow');
      setTimeout(()=>btn.classList.remove('tap-glow'),250);
    },{passive:true});
  });
})();
</script>

<script>
// ── Tooltip (mobile tap support) ──
(function(){
  const wraps=document.querySelectorAll('.tooltip-wrap');
  if(!wraps.length)return;
  wraps.forEach(wrap=>{
    wrap.addEventListener('touchstart',e=>{
      e.preventDefault();
      // Close other tooltips first
      wraps.forEach(w=>{if(w!==wrap)w.classList.remove('tapped')});
      wrap.classList.toggle('tapped');
    },{passive:false});
  });
  document.addEventListener('touchstart',e=>{
    if(!e.target.closest('.tooltip-wrap')){
      wraps.forEach(w=>w.classList.remove('tapped'));
    }
  },{passive:true});
})();
</script>

<script>
// ── Scroll-driven hero collapse + essay mode ──
(function(){
  const navTitle=document.getElementById('navTitle');
  const ciEl=document.querySelector('.ci');
  const essayView=document.getElementById('essayView');
  const essayTitle=document.getElementById('essayTitle');
  const essayBody=document.getElementById('essayBody');
  const vh=window.innerHeight;
  let ticking=false;
  let revealDone=false;
  let essayOpen=false;

  // Wait for .ci reveal animation to finish (~1.4s = 0.2s delay + 1.2s anim)
  setTimeout(()=>{
    revealDone=true;
    if(ciEl){ciEl.style.animation='none';ciEl.style.opacity='1';ciEl.style.transform='translateY(0)'}
    // Show scroll hint if touch device or page has overflow
    if(hintBottom&&(isTouchDevice||document.body.scrollHeight>window.innerHeight+50))
      hintBottom.classList.add('visible');
  },1500);

  const contentEl=document.querySelector('.content');
  const readingSec=document.getElementById('readingSection');
  const hintBottom=document.querySelector('.scroll-hint-bottom');

  const isTouchDevice=('ontouchstart' in window || navigator.maxTouchPoints > 0);
  let scrollLocked=false;
  let wasScrolledPast=false; // true once user has scrolled past the hero — prevents re-lock during initial smooth scroll

  // Initial scroll lock on touch devices
  if(isTouchDevice){
    scrollLocked=true;
    document.body.classList.add('scroll-locked');
    if(hintBottom) hintBottom.classList.add('tap-to-scroll');
  }

  function rebuildTree(){
    generateTree();initPetals();
    phase='drawing';bloomStart=0;shadowLayers=null;
  }

  // Pink line tap → nudge scroll down, then unlock on mobile
  if(hintBottom){
    hintBottom.addEventListener('touchstart',(e)=>{
      if(!scrollLocked) return;
      e.preventDefault();
      hintBottom.classList.add('tapped');
      setTimeout(()=>hintBottom.classList.remove('tapped'),200);
      hintBottom.classList.remove('tap-to-scroll');
      hintBottom.classList.remove('visible');
      scrollLocked=false;
      wasScrolledPast=false;
      // Phase 1: allow overflow but block touch-action so user finger doesn't hijack
      document.body.classList.remove('scroll-locked');
      document.body.classList.add('scroll-unlocking');
      // Phase 2: scroll down to reading/links section
      requestAnimationFrame(()=>{
        const scrollTarget=readingSec?readingSec.offsetTop:document.body.scrollHeight;
        window.scrollTo({top:scrollTarget,behavior:'smooth'});
        // Phase 3: fully unlock touch after smooth scroll settles
        setTimeout(()=>{
          document.body.classList.remove('scroll-unlocking');
        },1200);
      });
    },{passive:false});

    // Desktop click → smooth scroll to reading section
    hintBottom.addEventListener('click',(e)=>{
      if(isTouchDevice) return; // handled by touchstart on mobile
      e.preventDefault();
      const scrollTarget=readingSec?readingSec.offsetTop:document.body.scrollHeight;
      window.scrollTo({top:scrollTarget,behavior:'smooth'});
    });
  }

  // Essay link clicks — delegated so dynamically inserted links work
  const draftOverlay=document.getElementById('draftOverlay');
  const draftPopupTitle=document.getElementById('draftPopupTitle');
  const draftPopupCountdown=document.getElementById('draftPopupCountdown');
  const footerEl=document.getElementById('siteFooter');

  document.addEventListener('click',async e=>{
    const link=e.target.closest('[data-essay]');
    if(!link)return;
    e.preventDefault();

    // If parent <li> has data-draft, show draft popup instead of essay
    const li=link.closest('li');
    if(li&&li.hasAttribute('data-draft')){
      draftPopupTitle.textContent=link.textContent;
      // Copy countdown target from the li's countdown span
      const cdSpan=li.querySelector('.countdown[data-target]');
      if(cdSpan){
        draftPopupCountdown.setAttribute('data-target',cdSpan.dataset.target);
        window.startCountdowns();
      }
      draftOverlay.classList.add('open');
      return;
    }

    const slug=link.dataset.essay;
    const data=await loadEssay(slug);
    if(!data)return;

    // Fade out landing content
    if(contentEl) contentEl.style.opacity='0';
    if(readingSec) readingSec.style.opacity='0';
    if(footerEl) footerEl.style.opacity='0';
    if(hintBottom) hintBottom.classList.remove('visible');

    // After fade, rebuild tree on the side and show essay
    setTimeout(()=>{
      window.scrollTo({top:0,behavior:'instant'});
      essayMode=true;
      rebuildTree();

      essayTitle.textContent=data.title;
      essayBody.innerHTML=data.body;
      essayView.classList.add('open');
      essayOpen=true;
      navTitle.classList.add('show');
      if(isTouchDevice){scrollLocked=true;document.body.classList.add('scroll-locked')}
    },500);
  });

  function closeEssay(){
    // Fade out essay view first
    essayView.classList.remove('open');
    essayOpen=false;

    // Unlock scroll on touch devices
    if(isTouchDevice){
      scrollLocked=false;
      document.body.classList.remove('scroll-locked');
      if(hintBottom){hintBottom.classList.add('visible');hintBottom.classList.remove('tap-to-scroll')}
    }

    // After fade completes, rebuild tree in original position and restore landing
    setTimeout(()=>{
      window.scrollTo({top:0,behavior:'instant'});
      essayMode=false;
      rebuildTree();

      if(contentEl) contentEl.style.opacity='1';
      if(readingSec) readingSec.style.opacity='1';
      if(footerEl) footerEl.style.opacity='1';
      navTitle.classList.remove('show');
    },500);
  }

  navTitle.addEventListener('click',e=>{
    e.preventDefault();
    if(essayOpen){
      closeEssay();
      window.scrollTo({top:0,behavior:'smooth'});
    }else{
      window.scrollTo({top:0,behavior:'smooth'});
    }
  });
  navTitle.addEventListener('touchend',e=>{
    e.preventDefault();
    navTitle.click();
  },{passive:false});

  document.addEventListener('keydown',e=>{
    if(e.key==='Escape'&&essayOpen){e.preventDefault();closeEssay()}
  });

  window.addEventListener('scroll',()=>{
    if(ticking)return;
    ticking=true;
    requestAnimationFrame(()=>{
      const sy=window.scrollY;
      const progress=sy/(vh*.7);

      // Hero .ci fades out with slight parallax (progress 0.3–0.7)
      if(revealDone&&ciEl){
        if(progress<=.3){
          ciEl.style.opacity='1';
          ciEl.style.transform='translateY(0)';
        }else if(progress>=.7){
          ciEl.style.opacity='0';
          ciEl.style.transform='translateY(-30px)';
        }else{
          const fade=1-(progress-.3)/.4;
          ciEl.style.opacity=fade;
          ciEl.style.transform='translateY('+(-((1-fade)*30))+'px)';
        }
      }

      // Nav-title fades in when scrolled past halfway (or stays on in essay mode)
      if(essayOpen||progress>.5) navTitle.classList.add('show');
      else navTitle.classList.remove('show');

      // Track when user has scrolled past the hero (so we know a return to top is intentional)
      if(isTouchDevice&&!scrollLocked&&sy>vh*.5) wasScrolledPast=true;

      // Re-lock scroll when user scrolls back to top on mobile
      if(isTouchDevice&&!scrollLocked&&!essayOpen&&wasScrolledPast&&sy<=5){
        scrollLocked=true;
        wasScrolledPast=false;
        document.body.classList.add('scroll-locked');
        window.scrollTo({top:0,behavior:'instant'});
        if(hintBottom){hintBottom.classList.add('visible');hintBottom.classList.add('tap-to-scroll')}
      }

      // Scroll hint: on touch devices only show when locked; on desktop hide once text is visible
      if(hintBottom&&!essayOpen){
        if(isTouchDevice){
          // On mobile, hint is only visible in locked mode (managed by lock/unlock logic)
        } else if(!scrollLocked){
          if(sy>50)
            hintBottom.classList.remove('visible');
          else if(document.body.scrollHeight>window.innerHeight+50)
            hintBottom.classList.add('visible');
        }
      }

      ticking=false;
    });
  },{passive:true});
})();
</script>

<script>
// ── Tree Parameters (edit panel) ──
const treePresets={
  'Dark Wood':{
    shadowDarkness:2.4, shadowBlur:.45,
    drawSpeed:1.0, bloomSpeed:1.0, petalFadeRate:1.0,
    trunkThickness:1.0, branchSpread:1.0, maxDepth:5, branchDensity:1.0,
    treeHeight:1.0, treeWidth:1.0, treeStyle:'bonsai',
    petalDensity:1.0, glowIntensity:1.0,
  },
  'Shadow Cherry':{
    shadowDarkness:1.3, shadowBlur:1.0,
    drawSpeed:1.0, bloomSpeed:1.0, petalFadeRate:1.0,
    trunkThickness:1.0, branchSpread:1.0, maxDepth:5, branchDensity:1.0,
    treeHeight:1.0, treeWidth:1.0, treeStyle:'bonsai',
    petalDensity:1.0, glowIntensity:1.0,
  },
  'Dark Blossom':{
    shadowDarkness:2.2, shadowBlur:1.3,
    drawSpeed:1.0, bloomSpeed:1.0, petalFadeRate:1.0,
    trunkThickness:1.0, branchSpread:1.0, maxDepth:5, branchDensity:1.0,
    treeHeight:1.0, treeWidth:1.0, treeStyle:'bonsai',
    petalDensity:1.0, glowIntensity:1.4,
  },
};
let currentPreset='Dark Wood';
const treeParams=Object.assign({},treePresets['Dark Wood']);

// W, H = canvas resolution (tree coordinate space)
let W=window.innerWidth, H=window.innerHeight;
const isMobileTouch=('ontouchstart' in window || navigator.maxTouchPoints > 0);
let mx=-9999,my=-9999,nmx=.5,nmy=.5,smx=.5,smy=.5;
document.addEventListener('mousemove',e=>{
  mx=e.clientX; my=e.clientY;
  nmx=mx/W; nmy=my/H;
},{passive:true});

// Touch → cursor tracking
document.addEventListener('touchmove',e=>{
  const t=e.touches[0];
  mx=t.clientX; my=t.clientY;
  nmx=mx/W; nmy=my/H;
},{passive:true});
document.addEventListener('touchstart',e=>{
  const t=e.touches[0];
  mx=t.clientX; my=t.clientY;
  nmx=mx/W; nmy=my/H;
},{passive:true});

const moonEl=document.getElementById('moon');
function updateMoon(){smx+=(nmx-smx)*.08;smy+=(nmy-smy)*.08;moonEl.style.setProperty('--mx',(25+smx*40)+'%');moonEl.style.setProperty('--my',(3+smy*20)+'%')}

// Live resize — no reload, just update canvases
let resizeTimer=null;
let lastResizeW=window.innerWidth;
window.addEventListener('resize',()=>{
  clearTimeout(resizeTimer);
  resizeTimer=setTimeout(onResize, 150);
});

function onResize(){
  const newW=window.innerWidth, newH=window.innerHeight;
  const widthChanged=newW!==lastResizeW;

  // On mobile touch devices, ignore height-only changes entirely.
  // These are caused by the browser URL bar collapsing/expanding during scroll
  // and would cause the tree to visually shift/stretch.
  if(isMobileTouch && !widthChanged) return;

  lastResizeW=newW;
  W=newW; H=newH;

  // Resize display canvas (always needed)
  scene.width=W; scene.height=H;

  // Spatial hash
  COLS=Math.ceil(W/CELL)+1; ROWS=Math.ceil(H/CELL)+1;
  grid=new Array(COLS*ROWS);

  // Grain
  GW=(W/4)|0; GH=(H/4)|0;
  grainC.width=GW; grainC.height=GH;
  grainImg=gctx.createImageData(GW,GH); gd=grainImg.data;
  for(let i=3;i<gd.length;i+=4) gd[i]=10;

  if(widthChanged){
    // Full regeneration on width change
    treeC.width=W; treeC.height=H;
    treeX.lineCap='round'; treeX.lineJoin='round';
    generateTree();
    initPetals();
    phase='drawing';
    bloomStart=0;
    shadowLayers=null;
    // Update locked CSS heights on mobile (all layers, bottom-anchored)
    if(isMobileTouch){
      const lockH=H+'px';
      [scene,document.querySelector('.grain'),document.getElementById('moon'),document.querySelector('.vignette')].forEach(el=>{
        el.style.height=lockH;
      });
    }
  } else {
    // Height-only change on desktop: recompute shadows
    if(phase!=='drawing') computeShadows();
    else shadowLayers=null;
  }
}


// ═══════════════════════════════════════════════
// 1. PROCEDURAL BONSAI GENERATOR
// ═══════════════════════════════════════════════
function bzPt(t,x0,y0,cx0,cy0,cx1,cy1,x1,y1){
  const i=1-t;
  return{x:i*i*i*x0+3*i*i*t*cx0+3*i*t*t*cx1+t*t*t*x1, y:i*i*i*y0+3*i*i*t*cy0+3*i*t*t*cy1+t*t*t*y1};
}

const R=Math.random;
let allBranches=[];
let petalAnchors=[];

function makeBranch(x0,y0,cx0,cy0,cx1,cy1,x1,y1,thS,thE,parent,forkT,depth){
  const b={x0,y0,cx0,cy0,cx1,cy1,x1,y1,thS,thE,parent,forkT,depth,
    children:[],drawProg:0,drawSpeed:0,idx:allBranches.length};
  const len=Math.sqrt((x1-x0)**2+(y1-y0)**2);
  b.drawSpeed = Math.max(len,60) / (120 * treeParams.drawSpeed);
  allBranches.push(b);
  return b;
}

function addPetalsAlongBranch(b, count){
  count=Math.round(count*treeParams.petalDensity);
  if(count<=0)return;
  for(let i=0;i<count;i++){
    const t=.15+R()*.85;
    const p=bzPt(t,b.x0,b.y0,b.cx0,b.cy0,b.cx1,b.cy1,b.x1,b.y1);
    const t2=Math.min(t+.03,1);
    const p2=bzPt(t2,b.x0,b.y0,b.cx0,b.cy0,b.cx1,b.cy1,b.x1,b.y1);
    const nx=-(p2.y-p.y),ny=p2.x-p.x,nl=Math.sqrt(nx*nx+ny*ny)||1;
    const side=R()<.5?1:-1,off=2+R()*7;
    petalAnchors.push({x:p.x+(nx/nl)*side*off,y:p.y+(ny/nl)*side*off-R()*3,brIdx:b.idx,t});
  }
  for(let i=0;i<Math.ceil(count*.4);i++){
    petalAnchors.push({x:b.x1+(R()-.5)*14,y:b.y1+(R()-.5)*10-2,brIdx:b.idx,t:.95+R()*.05});
  }
}

function genBonsai(parent, forkT, x, y, angle, length, thickness, depth, maxDepth, side){
  if(depth>maxDepth||thickness<.7)return;
  const style=treeParams.treeStyle||'bonsai';
  let bendStr=(.2+R()*.5)*(R()<.5?1:-1);
  if(style==='willow'&&depth>=1) bendStr+=.25;
  if(style==='pine') bendStr*=.4;
  const ex=x+Math.cos(angle)*length,ey=y+Math.sin(angle)*length;
  const m1=.33,m2=.66;
  const cx0=x+Math.cos(angle+bendStr*.4)*length*m1;
  const cy0=y+Math.sin(angle+bendStr*.4)*length*m1;
  const cx1=x+Math.cos(angle-bendStr*.2)*length*m2;
  const cy1=y+Math.sin(angle-bendStr*.2)*length*m2;
  const thEnd=thickness*(depth<1?.55:.4+R()*.2);
  const b=makeBranch(x,y,cx0,cy0,cx1,cy1,ex,ey,thickness,Math.max(thEnd,.5),parent,forkT,depth);
  if(parent)parent.children.push(b);
  const petalCount=depth>=2?5+Math.floor(R()*6):(depth>=1?2+Math.floor(R()*3):0);
  addPetalsAlongBranch(b,petalCount);

  let numKids;
  if(depth===0)numKids=2+Math.floor(R()*2);
  else if(depth===1)numKids=2+Math.floor(R()*2);
  else if(depth===2)numKids=1+Math.floor(R()*2);
  else numKids=R()<.6?1:0;
  if(style==='willow'&&depth>=2) numKids=Math.max(numKids,1+Math.floor(R()*2));
  if(style==='pine'&&depth>=3) numKids=Math.min(numKids,R()<.4?1:0);
  numKids=Math.max(Math.round(numKids*treeParams.branchDensity),0);

  const forkSpots=[];
  for(let i=0;i<numKids;i++)forkSpots.push(.35+R()*.55);
  forkSpots.sort((a,c)=>a-c);

  for(let i=0;i<numKids;i++){
    const ft=forkSpots[i];
    const forkPt=bzPt(ft,x,y,cx0,cy0,cx1,cy1,ex,ey);
    let spreadBase=(depth<2?(.6+R()*.6):(.4+R()*.5))*treeParams.branchSpread;
    if(style==='willow') spreadBase*=1.3;
    if(style==='pine') spreadBase*=.55;
    const childSide=(i%2===0?-1:1)*(side||1);
    const spreadAngle=spreadBase*childSide;
    const ft2=Math.min(ft+.02,1);
    const fp2=bzPt(ft2,x,y,cx0,cy0,cx1,cy1,ex,ey);
    const tangent=Math.atan2(fp2.y-forkPt.y,fp2.x-forkPt.x);
    let childAngle=tangent+spreadAngle+(R()-.5)*.2;
    if(style==='willow'&&depth>=1) childAngle+=Math.min(depth*.12,.5);
    if(style==='pine') childAngle+=(-Math.PI/2-childAngle)*.15;
    const childLen=length*(.45+R()*.2)*treeParams.treeWidth;
    const childThick=thickness*(.4+R()*.2);
    genBonsai(b,ft,forkPt.x,forkPt.y,childAngle,childLen,childThick,depth+1,maxDepth,childSide);
  }
}

let essayMode=false;

function generateTree(){
  allBranches.length=0;
  petalAnchors.length=0;

  const isMobile = W < 768;
  let bx;
  if(essayMode){
    // Tree on the right side, flanking the centered essay
    bx = isMobile ? W*.75 : Math.min(W*.82+R()*.06, W-60);
  } else {
    bx = isMobile ? W*(.5+R()*.15) : Math.min(W*(.65+R()*.1), W-80);
  }
  const by = H*1.01;
  const trunkAngle=-Math.PI/2+(R()-.5)*.2;
  const trunkLen = (isMobile ? Math.min(H,W)*(.3+R()*.06) : H*(.25+R()*.08)) * treeParams.treeHeight;
  const trunkThick = (isMobile ? 18+R()*6 : 22+R()*8) * treeParams.trunkThickness;
  const maxD=treeParams.maxDepth;
  genBonsai(null,0,bx,by,trunkAngle,trunkLen,trunkThick,0,maxD,1);
  const t2angle=trunkAngle+(.2+R()*.3)*(R()<.5?-1:1);
  genBonsai(null,0,bx+(R()-.5)*8,by,t2angle,trunkLen*(.5+R()*.2),trunkThick*.45,1,maxD-1,-1);

  // Add small flowering spurs to depth 0-1 branches
  const branchSnapshot=allBranches.slice();
  branchSnapshot.forEach(b => {
    if(b.depth > 1) return;
    const numSpurs = b.depth === 0 ? 2+Math.floor(R()*3) : 1+Math.floor(R()*2);
    for(let s=0; s<numSpurs; s++){
      const ft = .25 + R()*.6;
      const fp = bzPt(ft, b.x0,b.y0,b.cx0,b.cy0,b.cx1,b.cy1,b.x1,b.y1);
      const ft2 = Math.min(ft+.02, 1);
      const fp2 = bzPt(ft2, b.x0,b.y0,b.cx0,b.cy0,b.cx1,b.cy1,b.x1,b.y1);
      const tang = Math.atan2(fp2.y-fp.y, fp2.x-fp.x);
      const side = (s%2===0?1:-1) * (R()<.3?-1:1);
      const spurAngle = tang + side*(.6+R()*.8);
      const spurLen = 15+R()*20;
      const ex = fp.x+Math.cos(spurAngle)*spurLen;
      const ey = fp.y+Math.sin(spurAngle)*spurLen;
      const cx0 = fp.x+Math.cos(spurAngle+.2)*spurLen*.4;
      const cy0 = fp.y+Math.sin(spurAngle+.2)*spurLen*.4;
      const cx1 = fp.x+Math.cos(spurAngle-.1)*spurLen*.7;
      const cy1 = fp.y+Math.sin(spurAngle-.1)*spurLen*.7;
      const spur = makeBranch(fp.x,fp.y,cx0,cy0,cx1,cy1,ex,ey, 2, .6, b, ft, b.depth+2);
      b.children.push(spur);
      addPetalsAlongBranch(spur, 4+Math.floor(R()*4));
    }
  });
}
generateTree();


// ═══════════════════════════════════════════════
// 2. ANIMATION
// ═══════════════════════════════════════════════
function easeOut(t){return 1-(1-t)*(1-t)*(1-t)}

function updateDrawProgress(dt){
  for(let i=0;i<allBranches.length;i++){
    const b=allBranches[i];
    if(b.drawProg>=1)continue;
    let canStart=!b.parent||b.parent.drawProg>=b.forkT;
    if(canStart) b.drawProg=Math.min(b.drawProg+dt/b.drawSpeed,1);
  }
}
function allDrawn(){for(let i=0;i<allBranches.length;i++)if(allBranches[i].drawProg<1)return false;return true}

function renderFullTree(ctx){
  ctx.clearRect(0,0,W,H);ctx.lineCap='round';ctx.lineJoin='round';
  for(let i=0;i<allBranches.length;i++){
    const b=allBranches[i];const segs=35;
    for(let j=0;j<segs;j++){
      const t0=j/segs,t1=(j+1)/segs;
      const p0=bzPt(t0,b.x0,b.y0,b.cx0,b.cy0,b.cx1,b.cy1,b.x1,b.y1);
      const p1=bzPt(t1,b.x0,b.y0,b.cx0,b.cy0,b.cx1,b.cy1,b.x1,b.y1);
      const w=b.thS+(b.thE-b.thS)*((t0+t1)/2);
      ctx.strokeStyle='#0a0608';ctx.lineWidth=Math.max(w,.4);
      ctx.beginPath();ctx.moveTo(p0.x,p0.y);ctx.lineTo(p1.x,p1.y);ctx.stroke();
    }
  }
}


// ═══════════════════════════════════════════════
// 3. PETAL SPRITES
// ═══════════════════════════════════════════════
const PC=[[245,175,195],[255,140,180],[250,225,235],[230,120,160]];

function makeFlower(r,g,b,sz){
  const d=Math.ceil(sz*7),c=document.createElement('canvas');c.width=d;c.height=d;
  const x=c.getContext('2d'),cx=d/2,cy=d/2;
  const gr=x.createRadialGradient(cx,cy,0,cx,cy,sz*2);
  gr.addColorStop(0,`rgba(${r},${g},${b},.4)`);gr.addColorStop(.5,`rgba(${r},${g},${b},.12)`);gr.addColorStop(1,`rgba(${r},${g},${b},0)`);
  x.fillStyle=gr;x.fillRect(0,0,d,d);
  x.fillStyle=`rgba(${r},${g},${b},.95)`;
  for(let i=0;i<5;i++){const a=(Math.PI*2*i)/5;x.save();x.translate(cx,cy);x.rotate(a);x.translate(sz*.35,0);x.beginPath();x.ellipse(0,0,sz*.5,sz*.25,0,0,Math.PI*2);x.fill();x.restore()}
  x.fillStyle='rgba(255,240,245,.7)';x.beginPath();x.arc(cx,cy,sz*.12,0,Math.PI*2);x.fill();
  return{canvas:c,cx:d/2,cy:d/2};
}

function makePetal(r,g,b,sz){
  const s=sz*1.2,p=4,dw=Math.ceil(s*1.2+p*2),dh=Math.ceil(s*1.6+p*2);
  const c=document.createElement('canvas');c.width=dw;c.height=dh;
  const x=c.getContext('2d'),cx=dw/2,cy=dh/2;
  x.fillStyle=`rgba(${Math.min(r+20,255)},${Math.min(g+20,255)},${Math.min(b+15,255)},.92)`;
  x.beginPath();x.moveTo(cx,cy-s*.7);
  x.bezierCurveTo(cx+s*.55,cy-s*.55,cx+s*.5,cy+s*.3,cx,cy+s*.7);
  x.bezierCurveTo(cx-s*.5,cy+s*.3,cx-s*.55,cy-s*.55,cx,cy-s*.7);x.fill();
  x.strokeStyle='rgba(255,240,248,.18)';x.lineWidth=.4;x.beginPath();x.moveTo(cx,cy-s*.45);x.quadraticCurveTo(cx+s*.06,cy,cx,cy+s*.45);x.stroke();
  x.fillStyle='rgba(255,235,245,.35)';x.beginPath();x.arc(cx,cy-s*.05,s*.08,0,Math.PI*2);x.fill();
  return{canvas:c,cx:dw/2,cy:dh/2};
}

const SZ=[3.5,5,6.5],fSpr=[],pSpr=[];
for(let ci=0;ci<4;ci++){fSpr[ci]=[];pSpr[ci]=[];const[r,g,b]=PC[ci];for(let si=0;si<SZ.length;si++){fSpr[ci][si]=makeFlower(r,g,b,SZ[si]);pSpr[ci][si]=makePetal(r,g,b,SZ[si])}}


// ═══════════════════════════════════════════════
// 4. SPATIAL HASH
// ═══════════════════════════════════════════════
const CELL=40;let COLS=Math.ceil(W/CELL)+1,ROWS=Math.ceil(H/CELL)+1,grid=new Array(COLS*ROWS);
function gCl(){for(let i=0;i<grid.length;i++)grid[i]=null}
function gIn(idx,x,y){const c=(x/CELL|0),r=(y/CELL|0);if(c<0||c>=COLS||r<0||r>=ROWS)return;const k=r*COLS+c;if(!grid[k])grid[k]=[idx];else grid[k].push(idx)}
function gQ(x,y,rad){const res=[],cr=Math.ceil(rad/CELL),cc=(x/CELL|0),rc=(y/CELL|0);for(let dr=-cr;dr<=cr;dr++)for(let dc=-cr;dc<=cr;dc++){const c=cc+dc,r=rc+dr;if(c<0||c>=COLS||r<0||r>=ROWS)continue;const cl=grid[r*COLS+c];if(cl)for(let i=0;i<cl.length;i++)res.push(cl[i])}return res}


// ═══════════════════════════════════════════════
// 5. PETALS
// ═══════════════════════════════════════════════
let N=petalAnchors.length;
const CURSOR_R=50,CURSOR_R2=CURSOR_R*CURSOR_R;
const CHAIN_R=30,CHAIN_R2=CHAIN_R*CHAIN_R;
const BLOOM_R=22,BLOOM_R2=BLOOM_R*BLOOM_R;

let ppx,ppy,pax,pay,pvx,pvy,pro,prv,psp,pss,psa,pgp,pal;
let pci,psi,pst,pct,prt,pbI,pbT,pBright;
let brSwX,brSwY,brMidX,brMidY;

const titleEl=document.getElementById('title');
let fadeY=titleEl?titleEl.getBoundingClientRect().bottom:H*.45;
let petalCycle='active';
let prevMx=mx,prevMy=my,curVX=0,curVY=0;
const SWAY_RANGE=200,SWAY_RANGE2=SWAY_RANGE*SWAY_RANGE;

// Track which branches are blooming
let bloomBranches=new Map();
let bloomFrame=0;
const BLOOM_HOP_DELAY=10;

function initPetals(){
  N=petalAnchors.length;
  ppx=new Float32Array(N);ppy=new Float32Array(N);
  pax=new Float32Array(N);pay=new Float32Array(N);
  pvx=new Float32Array(N);pvy=new Float32Array(N);
  pro=new Float32Array(N);prv=new Float32Array(N);
  psp=new Float32Array(N);pss=new Float32Array(N);psa=new Float32Array(N);
  pgp=new Float32Array(N);pal=new Float32Array(N);
  pci=new Uint8Array(N);psi=new Uint8Array(N);
  pst=new Uint8Array(N);pct=new Int16Array(N);prt=new Float32Array(N);
  pbI=new Uint16Array(N);pbT=new Float32Array(N);
  pBright=new Uint8Array(N);

  for(let i=0;i<N;i++){
    pax[i]=ppx[i]=petalAnchors[i].x;pay[i]=ppy[i]=petalAnchors[i].y;
    pbI[i]=petalAnchors[i].brIdx;pbT[i]=petalAnchors[i].t;
    pro[i]=R()*Math.PI*2;psp[i]=R()*Math.PI*2;pss[i]=.015+R()*.01;psa[i]=.5+R();pgp[i]=R()*Math.PI*2;
    pal[i]=0;const r=R();pci[i]=r<.45?0:r<.75?1:r<.9?2:3;psi[i]=(R()*3)|0;
    pst[i]=3;pct[i]=-1;prt[i]=0;
    pBright[i]=R()<.3?1:0;
  }

  fadeY=titleEl?titleEl.getBoundingClientRect().bottom:H*.45;
  petalCycle='active';
  bloomBranches=new Map();bloomFrame=0;

  // Branch sway arrays
  brSwX=new Float32Array(allBranches.length);
  brSwY=new Float32Array(allBranches.length);
  brMidX=new Float32Array(allBranches.length);
  brMidY=new Float32Array(allBranches.length);
  for(let i=0;i<allBranches.length;i++){
    const b=allBranches[i];
    const mp=bzPt(.5,b.x0,b.y0,b.cx0,b.cy0,b.cx1,b.cy1,b.x1,b.y1);
    brMidX[i]=mp.x;brMidY[i]=mp.y;
  }
}
initPetals();




function freeP(i,fromCursor){
  if(pst[i]!==0)return;pst[i]=1;pal[i]=1;
  // Aim toward upper-left corner from current position
  const tx=-W*.1,ty=-H*.1; // target: just past upper-left corner
  const dx=tx-ppx[i],dy=ty-ppy[i];
  const d=Math.sqrt(dx*dx+dy*dy)||1;
  const spd=.15+R()*.1;
  pvx[i]=dx/d*spd;
  pvy[i]=dy/d*spd;
  if(fromCursor){
    const cdx=ppx[i]-mx,cdy=ppy[i]-my,cd=Math.sqrt(cdx*cdx+cdy*cdy)||1;
    pvx[i]+=(cdx/cd)*.04;pvy[i]+=(cdy/cd)*.03;
  }
  prv[i]=(R()-.5)*.008;
}

function chain(i){
  const nb=gQ(ppx[i],ppy[i],CHAIN_R);
  for(let j=0;j<nb.length;j++){const k=nb[j];if(pst[k]!==0||pct[k]>=0)continue;const dx=ppx[k]-ppx[i],dy=ppy[k]-ppy[i];if(dx*dx+dy*dy<CHAIN_R2)pct[k]=4+(R()*6|0)}
}

// Petals revealed in blooming phase (see main loop)

function spreadBloom(){
  bloomFrame++;
  // For each branch in the map, check if it's time to spread to children
  const toAdd=[];
  bloomBranches.forEach((addedFrame, bi) => {
    if(bloomFrame - addedFrame < BLOOM_HOP_DELAY) return;
    const b=allBranches[bi];
    if(!b) return;
    for(let c=0;c<b.children.length;c++){
      const ci=b.children[c].idx;
      if(!bloomBranches.has(ci)) toAdd.push([ci, bloomFrame]);
    }
  });
  for(let i=0;i<toAdd.length;i++) bloomBranches.set(toAdd[i][0], toAdd[i][1]);
}

function updatePetals(){
  fadeY=titleEl?titleEl.getBoundingClientRect().bottom:H*.45;
  gCl();

  // Cursor velocity (smoothed)
  curVX+=(mx-prevMx-curVX)*.15;
  curVY+=(my-prevMy-curVY)*.15;
  curVX*=.92;curVY*=.92;
  prevMx=mx;prevMy=my;
  const curSpeed=Math.sqrt(curVX*curVX+curVY*curVY);

  // Per-branch sway: each branch responds to cursor wind independently
  for(let bi=0;bi<allBranches.length;bi++){
    const dx=brMidX[bi]-mx,dy=brMidY[bi]-my;
    const d2=dx*dx+dy*dy;
    if(d2<SWAY_RANGE2){
      const prox=1-Math.sqrt(d2)/SWAY_RANGE;
      // Branches at different depths sway differently (deeper = more flexible)
      const flex=.3+allBranches[bi].depth*.12;
      brSwX[bi]+=(curVX*prox*flex-brSwX[bi])*.12;
      brSwY[bi]+=(curVY*prox*flex*.6-brSwY[bi])*.12;
    } else {
      brSwX[bi]*=.94;brSwY[bi]*=.94;
    }
  }


  let flyingCount=0, barrenCount=0, restingCount=0;
  for(let i=0;i<N;i++){
    if(pst[i]===1) flyingCount++;
    else if(pst[i]===2) barrenCount++;
    else if(pst[i]===0) restingCount++;
  }

  // Phase transitions
  if(petalCycle==='active' && restingCount===0 && flyingCount===0){
    petalCycle='reblooming';
    bloomBranches.clear();bloomFrame=0;
  }
  if(petalCycle==='reblooming' && barrenCount===0){
    petalCycle='active';
    bloomBranches.clear();
  }

  const canRelease=(petalCycle==='active');
  const canRebloom=(petalCycle==='reblooming');

  // Spread bloom to adjacent branches each frame
  if(canRebloom && bloomBranches.size>0) spreadBloom();

  for(let i=0;i<N;i++)if(pst[i]===0)gIn(i,ppx[i],ppy[i]);

  for(let i=0;i<N;i++){
    if(pst[i]===3)continue;
    psp[i]+=pss[i];pgp[i]+=.01;


    if(pst[i]===0){
      ppx[i]=pax[i]+Math.sin(psp[i])*psa[i];
      ppy[i]=pay[i]+Math.cos(psp[i]*.7)*psa[i]*.5;
      if(canRelease){
        const dx=ppx[i]-mx,dy=ppy[i]-my;
        if(dx*dx+dy*dy<CURSOR_R2){freeP(i,true)}
      }
      continue;
    }

    if(pst[i]===1){
      // Only start fading once above the title
      if(ppy[i]<fadeY){
        const fadeRate=(pBright[i]?.0008:.0015)*treeParams.petalFadeRate;
        pal[i]-=fadeRate;
      }
      // Pull toward upper-left corner from current position
      const tx=-W*.1,ty=-H*.1;
      const dx=tx-ppx[i],dy=ty-ppy[i];
      const d=Math.sqrt(dx*dx+dy*dy)||1;
      pvx[i]+=(dx/d)*.002;
      pvy[i]+=(dy/d)*.002;
      // Tiny organic wobble
      const t=psp[i];
      pvx[i]+=Math.sin(t*.08+i)*.0004;
      pvy[i]+=Math.cos(t*.06+i*.7)*.0003;
      pvx[i]*=.998;pvy[i]*=.998;
      ppx[i]+=pvx[i];ppy[i]+=pvy[i];
      pro[i]+=prv[i];prv[i]*=.9998;
      if(pal[i]<=0||ppy[i]<-30){pst[i]=2;pal[i]=0;prt[i]=1}
      continue;
    }

    if(pst[i]===2){
      ppx[i]=pax[i]+Math.sin(psp[i])*psa[i];
      ppy[i]=pay[i]+Math.cos(psp[i]*.7)*psa[i]*.5;
      if(prt[i]===1){
        if(!canRebloom) continue;
        // Cursor contact — seed this branch into bloom spread
        const dx=pax[i]-mx,dy=pay[i]-my;
        if(dx*dx+dy*dy<BLOOM_R2){
          if(!bloomBranches.has(pbI[i])){
            bloomBranches.set(pbI[i], bloomFrame);
            // Also add immediate parent so bloom looks connected
            const b=allBranches[pbI[i]];
            if(b.parent&&!bloomBranches.has(b.parent.idx)){
              bloomBranches.set(b.parent.idx, bloomFrame);
            }
          }
          prt[i]=0;pal[i]=0;
        }
        // Check if bloom wave has reached this branch
        if(bloomBranches.has(pbI[i])){
          prt[i]=0;pal[i]=0;
        }
        continue;
      }
      // Slower bloom fade-in
      pal[i]+=.025*treeParams.bloomSpeed;
      if(pal[i]>=1){pal[i]=1;pst[i]=0;pct[i]=-1;pvx[i]=0;pvy[i]=0}
    }
  }
}


// ═══════════════════════════════════════════════
// 6. SCENE CANVAS + SHADOWS
// ═══════════════════════════════════════════════
const scene=document.getElementById('scene');
scene.width=W;scene.height=H;
const ctx=scene.getContext('2d');

// On mobile, lock ALL fixed visual layers to the same height, bottom-anchored.
// This prevents the URL bar collapse/expand from causing any layer to move
// at a different rate, which would create a visible seam between layers.
if(isMobileTouch){
  const lockH=H+'px';
  [scene,document.querySelector('.grain'),document.getElementById('moon'),document.querySelector('.vignette')].forEach(el=>{
    el.style.height=lockH;
    el.style.top='auto';  // override inset:0's top:0; bottom:0 anchors to viewport bottom
  });
}

const treeC=document.createElement('canvas');treeC.width=W;treeC.height=H;
const treeX=treeC.getContext('2d');treeX.lineCap='round';treeX.lineJoin='round';

let shadowLayers=null,moonEdgeC=null;

function buildShadowLayers(){
  shadowLayers=[];
  [{blur:50*treeParams.shadowBlur,a:.07,ox:-6,oy:-6},{blur:28*treeParams.shadowBlur,a:.12,ox:-2,oy:-2},{blur:14*treeParams.shadowBlur,a:.16,ox:0,oy:0},{blur:5*treeParams.shadowBlur,a:.12,ox:1,oy:1}].forEach(p=>{
    const c=document.createElement('canvas');c.width=W;c.height=H;
    const cx=c.getContext('2d');cx.filter=`blur(${p.blur}px)`;cx.drawImage(treeC,0,0,W,H);
    shadowLayers.push({canvas:c,alpha:p.a,ox:p.ox,oy:p.oy});
  });
  moonEdgeC=document.createElement('canvas');moonEdgeC.width=W;moonEdgeC.height=H;
  const me=moonEdgeC.getContext('2d');me.filter='blur(28px)';me.drawImage(treeC,0,0,W,H);
}

function computeShadows(){
  renderFullTree(treeX);
  buildShadowLayers();
}

let shOX=0,shOY=0,swT=0;

function renderShadow(){
  if(!shadowLayers)return;
  const tx=(smx-.5)*-3,ty=(smy-.5)*-2;
  shOX+=(tx-shOX)*.04;shOY+=(ty-shOY)*.04;swT+=.005;
  const dx=shOX+Math.sin(swT*.5)*.5,dy=shOY+Math.cos(swT*.35)*.4;
  for(let i=0;i<shadowLayers.length;i++){const l=shadowLayers[i];ctx.globalAlpha=l.alpha*treeParams.shadowDarkness;ctx.drawImage(l.canvas,dx+l.ox,dy+l.oy)}
  ctx.globalAlpha=.025;ctx.globalCompositeOperation='screen';
  ctx.drawImage(moonEdgeC,dx+3,dy+3);
  ctx.globalCompositeOperation='source-over';ctx.globalAlpha=1;
}

function renderPetals(){
  // Resting + barren petals (state 0, 2) — with branch wind sway
  for(let i=0;i<N;i++){
    if(pst[i]!==0&&pst[i]!==2)continue;if(pal[i]<=.01)continue;
    const s=fSpr[pci[i]][psi[i]];
    const bi=pbI[i];
    ctx.globalAlpha=Math.min(pal[i]*1.1,1);
    ctx.drawImage(s.canvas,ppx[i]+brSwX[bi]-s.cx,ppy[i]+brSwY[bi]-s.cy);
  }

  // Freed petals (state 1) — flower sprite shrinking + petal + glow
  for(let i=0;i<N;i++){
    if(pst[i]!==1)continue;if(pal[i]<=.01)continue;
    const x=ppx[i],y=ppy[i];
    const heightRatio=Math.max(0,1-y/H);
    const glowIntensity=heightRatio*heightRatio*treeParams.glowIntensity;

    // Gradual shrink: starts at 50% screen height, smoothstep to dot
    const shrinkStart=H*.5;
    let scale=1;
    if(y<shrinkStart){
      const t=Math.max(y/shrinkStart, 0); // 1 at shrinkStart, 0 at top
      scale=t*t*(3-2*t); // smoothstep: gradual ease at both ends
      scale=.15+scale*.85; // range: 0.15 (tiny dot) to 1.0 (full)
    }

    // Soft halo glow
    if(glowIntensity>.05){
      const ci=PC[pci[i]];
      const brightMul=pBright[i]?1.8:1;
      const wr=Math.min(ci[0]+glowIntensity*60*brightMul,255);
      const wg=Math.min(ci[1]+glowIntensity*80*brightMul,255);
      const wb=Math.min(ci[2]+glowIntensity*50*brightMul,255);
      const glowAlpha=pBright[i]?glowIntensity*.7:glowIntensity*.5;
      const gRad=(8+glowIntensity*(pBright[i]?35:25))*scale;
      const gr=ctx.createRadialGradient(x,y,0,x,y,gRad);
      gr.addColorStop(0,`rgba(${wr|0},${wg|0},${wb|0},${pal[i]*glowAlpha})`);
      gr.addColorStop(.5,`rgba(${wr|0},${wg|0},${wb|0},${pal[i]*glowAlpha*.3})`);
      gr.addColorStop(1,`rgba(${wr|0},${wg|0},${wb|0},0)`);
      ctx.globalAlpha=1;ctx.fillStyle=gr;
      ctx.beginPath();ctx.arc(x,y,gRad,0,Math.PI*2);ctx.fill();
    }

    // Flower sprite
    const fs=fSpr[pci[i]][psi[i]];
    const brightBoost=pBright[i]?glowIntensity*.5:glowIntensity*.3;
    ctx.globalAlpha=Math.min(pal[i]*(1+brightBoost),1);
    ctx.save();ctx.translate(x,y);ctx.scale(scale,scale);ctx.rotate(pro[i]*.3);
    ctx.drawImage(fs.canvas,-fs.cx,-fs.cy);ctx.restore();

    // Petal sprite
    const ps=pSpr[pci[i]][psi[i]];
    ctx.globalAlpha=Math.min(pal[i]*(1+brightBoost),1);
    ctx.save();ctx.translate(x,y);ctx.scale(scale,scale);ctx.rotate(pro[i]);
    ctx.drawImage(ps.canvas,-ps.cx,-ps.cy);ctx.restore();

    // Bright petals: white screen overlay
    if(pBright[i]&&glowIntensity>.15){
      ctx.globalCompositeOperation='screen';
      ctx.globalAlpha=pal[i]*glowIntensity*.6;
      ctx.fillStyle='rgba(255,240,250,.9)';
      ctx.beginPath();ctx.arc(x,y,(3+glowIntensity*4)*scale,0,Math.PI*2);ctx.fill();
      ctx.globalCompositeOperation='source-over';
    }
  }

  // Gust halo — soft radial glow around cursor when moving fast
  const curSpeed=Math.sqrt(curVX*curVX+curVY*curVY);
  if(curSpeed>3){
    const gustAlpha=Math.min((curSpeed-3)*.008,.06);
    const gustR=40+curSpeed*3;
    const gg=ctx.createRadialGradient(mx,my,0,mx,my,gustR);
    gg.addColorStop(0,`rgba(220,200,215,${gustAlpha})`);
    gg.addColorStop(.6,`rgba(220,200,215,${gustAlpha*.3})`);
    gg.addColorStop(1,'rgba(220,200,215,0)');
    ctx.fillStyle=gg;
    ctx.beginPath();ctx.arc(mx,my,gustR,0,Math.PI*2);ctx.fill();
  }


  ctx.globalAlpha=1;
}


// ═══════════════════════════════════════════════
// 7. FILM GRAIN
// ═══════════════════════════════════════════════
const grainC=document.getElementById('grain');
let GW=(W/4)|0,GH=(H/4)|0;
grainC.width=GW;grainC.height=GH;grainC.style.width='100%';grainC.style.height='100%';
const gctx=grainC.getContext('2d');
let grainImg=gctx.createImageData(GW,GH);let gd=grainImg.data;
for(let i=3;i<gd.length;i+=4)gd[i]=10;
let gf=0;
function renderGrain(){if(++gf%4!==0)return;for(let i=0;i<gd.length;i+=4){const v=(R()*255)|0;gd[i]=gd[i+1]=gd[i+2]=v}gctx.putImageData(grainImg,0,0)}


// ═══════════════════════════════════════════════
// MAIN LOOP
// ═══════════════════════════════════════════════
let partialShadowFrame=0;

function renderPartialShadow(){
  treeX.clearRect(0,0,W,H);treeX.lineCap='round';treeX.lineJoin='round';
  for(let d=0;d<=6;d++){
    for(let i=0;i<allBranches.length;i++){
      const b=allBranches[i];
      if(b.depth!==d||b.drawProg<=0)continue;
      const prog=easeOut(Math.min(b.drawProg,1));
      const segs=35,maxSeg=Math.max(Math.floor(segs*prog),1);
      for(let j=0;j<maxSeg;j++){
        const t0=j/segs,t1=(j+1)/segs;
        const p0=bzPt(t0,b.x0,b.y0,b.cx0,b.cy0,b.cx1,b.cy1,b.x1,b.y1);
        const p1=bzPt(t1,b.x0,b.y0,b.cx0,b.cy0,b.cx1,b.cy1,b.x1,b.y1);
        const w=b.thS+(b.thE-b.thS)*((t0+t1)/2);
        treeX.strokeStyle='#0a0608';treeX.lineWidth=Math.max(w,.4);
        treeX.beginPath();treeX.moveTo(p0.x,p0.y);treeX.lineTo(p1.x,p1.y);treeX.stroke();
      }
    }
  }
  // Recompute blur shadows from partial tree every 6 frames (same look as final)
  if(++partialShadowFrame%6===0) buildShadowLayers();
  if(shadowLayers) renderShadow();
}

let phase='drawing'; // drawing | blooming | interactive
let frameCount=0;
let bloomStart=0;

function tick(now){
  frameCount++;
  updateMoon();
  ctx.clearRect(0,0,W,H);

  if(phase==='drawing'){
    updateDrawProgress(1/60);
    renderPartialShadow();
    // No petals during drawing
    if(allDrawn()){
      computeShadows();
      bloomStart=now;
      phase='blooming';
    }
  }
  else if(phase==='blooming'){
    renderShadow();

    // Staggered bloom: petals on deeper/later branches appear later
    const elapsed = now - bloomStart;
    for(let i=0;i<N;i++){
      if(pst[i]!==3) continue;
      const b=allBranches[pbI[i]];
      const delay = (b.depth <= 2 ? 80 : b.depth === 3 ? 200 : 350) / treeParams.bloomSpeed;
      const jitter = pbT[i] * 120 / treeParams.bloomSpeed;
      if(elapsed >= delay + jitter){
        pst[i]=0; pal[i]=0; prt[i]=0;
      }
    }
    // Fade in visible petals
    for(let i=0;i<N;i++){
      if(pst[i]===0 && pal[i]<1){pal[i]+=.035*treeParams.bloomSpeed;if(pal[i]>1)pal[i]=1}
    }

    renderPetals();

    // Done when all petals are revealed
    let allRevealed=true;
    for(let i=0;i<N;i++){if(pst[i]===3){allRevealed=false;break}}
    if(allRevealed && elapsed>600) phase='interactive';
  }
  else{
    renderShadow();
    updatePetals();
    renderPetals();
  }

  renderGrain();
  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);
</script>

<script>
// ── Audio system with track picker ──
(function(){
  const btn = document.getElementById('audioBtn');
  const audio = document.getElementById('bgMusic');
  const cvs = document.getElementById('audioWave');
  const cx = cvs.getContext('2d');
  const w = cvs.width, h = cvs.height;
  const midY = h / 2;

  const npLabel = document.getElementById('nowPlaying');
  const npInfo = document.getElementById('npInfo');
  const npTitle = document.getElementById('npTitle');
  const npArtist = document.getElementById('npArtist');
  const picker = document.getElementById('songPicker');

  // Track list — parsed from filenames (Song Name_Artist.mp3)
  let tracks = [
    'Oogway Ascends_Hans Zimmer.mp3',
    'Moses_Ennio Morricone.mp3',
  ];

  function parseTrack(filename){
    const name = filename.replace(/\.mp3$/,'');
    const sep = name.indexOf('_');
    return { file: filename, title: name.substring(0,sep), artist: name.substring(sep+1) };
  }

  let trackList = tracks.map(parseTrack);
  let currentTrack = 0;
  let playing = false;
  let amplitude = 0;
  let phase = 0;
  let glowAmount = 0;
  let pickerOpen = false;

  // Build picker items
  function buildPicker(){
    picker.innerHTML = '';
    trackList.forEach((t, i) => {
      const btn = document.createElement('button');
      btn.className = 'song-picker-item' + (i === currentTrack ? ' active' : '');
      btn.innerHTML = '<div class="sp-title">"'+t.title+'"</div><div class="sp-artist">'+t.artist+'</div>';
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        switchTrack(i);
        closePicker();
      });
      picker.appendChild(btn);
    });
  }

  function loadTrack(i){
    currentTrack = i;
    const t = trackList[i];
    audio.src = 'audio/bgm/' + encodeURIComponent(t.file);
    npTitle.textContent = '"' + t.title + '"';
    npArtist.textContent = t.artist;
  }

  function switchTrack(i){
    if(i === currentTrack && playing) return;
    loadTrack(i);
    audio.play();
    startPlaying();
    buildPicker();
  }

  function startPlaying(){
    playing = true;
    btn.classList.add('playing');
    npLabel.classList.add('show');
  }
  function stopPlaying(){
    playing = false;
    btn.classList.remove('playing');
    npLabel.classList.remove('show');
    closePicker();
  }

  function togglePicker(){
    pickerOpen ? closePicker() : openPicker();
  }
  function openPicker(){
    buildPicker();
    pickerOpen = true;
    picker.classList.add('open');
  }
  function closePicker(){
    pickerOpen = false;
    picker.classList.remove('open');
  }

  // Init first track
  loadTrack(0);
  buildPicker();

  // Allow content loader to update tracks from content.md
  window.__updateTracks = function(newTracks){
    tracks = newTracks;
    trackList = tracks.map(parseTrack);
    buildPicker();
    if(!playing) loadTrack(0);
  };

  btn.addEventListener('click', () => {
    if(!playing){
      audio.play();
      startPlaying();
    } else {
      audio.pause();
      stopPlaying();
    }
  });

  npInfo.addEventListener('click', (e) => {
    e.stopPropagation();
    togglePicker();
  });

  // Close picker on outside click
  document.addEventListener('click', (e) => {
    if(pickerOpen && !picker.contains(e.target) && !npInfo.contains(e.target)){
      closePicker();
    }
  });

  function drawWave(){
    cx.clearRect(0, 0, w, h);

    const target = playing ? 1 : 0;
    amplitude += (target - amplitude) * .06;
    glowAmount += (target - glowAmount) * .04;
    phase += playing ? .034 : .0084;

    if(!playing && amplitude < .005) amplitude = 0;

    const pad = 5;
    const lineW = w - pad * 2;

    if(glowAmount > .01){
      cx.save();
      cx.filter = 'blur(3px)';
      cx.strokeStyle = `rgba(242,160,181,${glowAmount * .5})`;
      cx.lineWidth = 2.5;
      cx.beginPath();
      for(let i = 0; i <= lineW; i++){
        const t = i / lineW;
        const x = pad + i;
        const waveY = Math.sin(t * Math.PI * 2.5 + phase) * amplitude * 5;
        const y = midY + waveY;
        i === 0 ? cx.moveTo(x, y) : cx.lineTo(x, y);
      }
      cx.stroke();
      cx.restore();
    }

    const r = 255 - glowAmount * 13;
    const g = 255 - glowAmount * 95;
    const b = 255 - glowAmount * 60;
    cx.strokeStyle = `rgba(${r|0},${g|0},${b|0},${.6 + glowAmount * .3})`;
    cx.lineWidth = 1.2;
    cx.lineCap = 'round';
    cx.beginPath();
    for(let i = 0; i <= lineW; i++){
      const t = i / lineW;
      const x = pad + i;
      const waveY = Math.sin(t * Math.PI * 2.5 + phase) * amplitude * 5;
      const y = midY + waveY;
      i === 0 ? cx.moveTo(x, y) : cx.lineTo(x, y);
    }
    cx.stroke();

    requestAnimationFrame(drawWave);
  }
  drawWave();
})();
</script>

<script>
// ── Edit Panel controller ──
(function(){
  const panel=document.getElementById('editPanel');
  const closeBtn=document.getElementById('epClose');
  const presetsEl=document.getElementById('epPresets');
  let open=false;

  const shapeParams=new Set(['trunkThickness','branchSpread','maxDepth','branchDensity','petalDensity','treeHeight','treeWidth']);
  const shadowParams=new Set(['shadowDarkness','shadowBlur']);
  const sliders=panel.querySelectorAll('input[type="range"]');
  const stylesEl=document.getElementById('epStyles');
  const treeStyles=['bonsai','willow','pine'];

  function toggle(){open?close():openPanel()}
  function openPanel(){open=true;panel.classList.add('open')}
  function close(){open=false;panel.classList.remove('open')}

  // Sync all sliders + style to current treeParams
  function syncSliders(){
    sliders.forEach(s=>{
      const p=s.dataset.param;
      const v=treeParams[p];
      s.value=v;
      document.getElementById('val-'+p).textContent=p==='maxDepth'?v:v.toFixed(2);
    });
    buildStyles();
  }

  // Build preset buttons
  function buildPresets(){
    presetsEl.innerHTML='';
    Object.keys(treePresets).forEach(name=>{
      const btn=document.createElement('button');
      btn.className='ep-preset-btn'+(name===currentPreset?' active':'');
      btn.textContent=name;
      btn.addEventListener('click',()=>applyPreset(name));
      presetsEl.appendChild(btn);
    });
  }

  // Build tree style buttons
  function buildStyles(){
    stylesEl.innerHTML='';
    treeStyles.forEach(s=>{
      const btn=document.createElement('button');
      btn.className='ep-style-btn'+(s===treeParams.treeStyle?' active':'');
      btn.textContent=s;
      btn.addEventListener('click',()=>{
        treeParams.treeStyle=s;
        buildStyles();
        generateTree();initPetals();
        phase='drawing';bloomStart=0;shadowLayers=null;
        partialShadowFrame=0;
      });
      stylesEl.appendChild(btn);
    });
  }

  function applyPreset(name){
    currentPreset=name;
    Object.assign(treeParams,treePresets[name]);
    syncSliders();
    buildPresets();
    // Regen tree for shape params, recompute shadows
    generateTree();initPetals();
    phase='drawing';bloomStart=0;shadowLayers=null;
    partialShadowFrame=0;
  }

  buildPresets();
  buildStyles();

  document.addEventListener('keydown',e=>{
    if(e.ctrlKey&&e.shiftKey&&e.code==='KeyH'){e.preventDefault();toggle()}
    if(e.key==='Escape'&&open){e.preventDefault();close()}
  });
  closeBtn.addEventListener('click',close);

  // Slider events
  sliders.forEach(slider=>{
    const param=slider.dataset.param;
    const valEl=document.getElementById('val-'+param);

    slider.addEventListener('input',()=>{
      const v=param==='maxDepth'?parseInt(slider.value):parseFloat(slider.value);
      treeParams[param]=v;
      valEl.textContent=param==='maxDepth'?v:v.toFixed(2);

      if(shapeParams.has(param)){
        generateTree();initPetals();
        if(typeof computeShadows==='function'&&phase!=='drawing'){
          computeShadows();
        }
        phase='drawing';bloomStart=0;shadowLayers=null;
        partialShadowFrame=0;
      } else if(shadowParams.has(param)){
        if(typeof computeShadows==='function'&&phase!=='drawing'){
          computeShadows();
        }
      }
    });
  });

  // Text border toggle (on by default → toggle removes it)
  const textBorderBtn=document.getElementById('toggleTextBorder');
  let textBorderOn=true;
  textBorderBtn.classList.add('active');
  textBorderBtn.addEventListener('click',()=>{
    textBorderOn=!textBorderOn;
    textBorderBtn.classList.toggle('active',textBorderOn);
    document.body.classList.toggle('no-text-border',!textBorderOn);
  });

  // Chraist symbol scroll pointer toggle (on by default)
  const chraistHintBtn=document.getElementById('toggleChraistHint');
  const scrollHint=document.querySelector('.scroll-hint-bottom');
  let chraistHintOn=true;
  chraistHintBtn.classList.add('active');
  if(scrollHint) scrollHint.classList.add('chraist-hint');
  chraistHintBtn.addEventListener('click',()=>{
    chraistHintOn=!chraistHintOn;
    chraistHintBtn.classList.toggle('active',chraistHintOn);
    if(scrollHint) scrollHint.classList.toggle('chraist-hint',chraistHintOn);
  });

  // Cursor style picker — mutually exclusive: arrow | chraist dark | chraist white
  const cursorOptions=[
    {name:'arrow',label:'arrow',bodyClass:null},
    {name:'dark',label:'chraist dark',bodyClass:'cursor-chraist-dark'},
    {name:'white',label:'chraist white',bodyClass:'cursor-chraist-white'}
  ];
  let activeCursor='white';
  document.body.classList.add('cursor-chraist-white');
  const cursorStylesEl=document.getElementById('epCursorStyles');
  function buildCursorStyles(){
    cursorStylesEl.innerHTML='';
    cursorOptions.forEach(opt=>{
      const btn=document.createElement('button');
      btn.className='ep-style-btn'+(activeCursor===opt.name?' active':'');
      btn.textContent=opt.label;
      btn.addEventListener('click',()=>{
        // Remove all cursor classes
        cursorOptions.forEach(o=>{if(o.bodyClass)document.body.classList.remove(o.bodyClass)});
        activeCursor=opt.name;
        if(opt.bodyClass) document.body.classList.add(opt.bodyClass);
        buildCursorStyles();
      });
      cursorStylesEl.appendChild(btn);
    });
  }
  buildCursorStyles();
})();
</script>
</body>
</html>
